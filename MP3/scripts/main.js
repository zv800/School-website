"use strict";window.DOMHandler=class{constructor(a,b){this._iRuntime=a,this._componentId=b,this._hasTickCallback=!1,this._tickCallback=()=>this.Tick()}Attach(){}PostToRuntime(a,b,c,d){this._iRuntime.PostToRuntimeComponent(this._componentId,a,b,c,d)}PostToRuntimeAsync(a,b,c,d){return this._iRuntime.PostToRuntimeComponentAsync(this._componentId,a,b,c,d)}_PostToRuntimeMaybeSync(a,b,c){this._iRuntime.UsesWorker()?this.PostToRuntime(a,b,c):this._iRuntime._GetLocalRuntime()["_OnMessageFromDOM"]({"type":"event","component":this._componentId,"handler":a,"dispatchOpts":c||null,"data":b,"responseId":null})}AddRuntimeMessageHandler(a,b){this._iRuntime.AddRuntimeComponentMessageHandler(this._componentId,a,b)}AddRuntimeMessageHandlers(a){for(const[b,c]of a)this.AddRuntimeMessageHandler(b,c)}GetRuntimeInterface(){return this._iRuntime}GetComponentID(){return this._componentId}_StartTicking(){this._hasTickCallback||(this._iRuntime._AddRAFCallback(this._tickCallback),this._hasTickCallback=!0)}_StopTicking(){this._hasTickCallback&&(this._iRuntime._RemoveRAFCallback(this._tickCallback),this._hasTickCallback=!1)}Tick(){}},window.RateLimiter=class{constructor(a,b){this._callback=a,this._interval=b,this._timerId=-1,this._lastCallTime=-Infinity,this._timerCallFunc=()=>this._OnTimer(),this._ignoreReset=!1,this._canRunImmediate=!1}SetCanRunImmediate(a){this._canRunImmediate=!!a}Call(){if(-1===this._timerId){const a=Date.now(),b=a-this._lastCallTime,c=this._interval;b>=c&&this._canRunImmediate?(this._lastCallTime=a,this._RunCallback()):this._timerId=self.setTimeout(this._timerCallFunc,Math.max(c-b,4))}}_RunCallback(){this._ignoreReset=!0,this._callback(),this._ignoreReset=!1}Reset(){this._ignoreReset||(this._CancelTimer(),this._lastCallTime=Date.now())}_OnTimer(){this._timerId=-1,this._lastCallTime=Date.now(),this._RunCallback()}_CancelTimer(){-1!==this._timerId&&(self.clearTimeout(this._timerId),this._timerId=-1)}Release(){this._CancelTimer(),this._callback=null,this._timerCallFunc=null}};

"use strict";window.DOMElementHandler=class extends DOMHandler{constructor(a,b){super(a,b),this._elementMap=new Map,this._autoAttach=!0,this.AddRuntimeMessageHandler("create",(a)=>this._OnCreate(a)),this.AddRuntimeMessageHandler("destroy",(a)=>this._OnDestroy(a)),this.AddRuntimeMessageHandler("set-visible",(a)=>this._OnSetVisible(a)),this.AddRuntimeMessageHandler("update-position",(a)=>this._OnUpdatePosition(a)),this.AddRuntimeMessageHandler("update-state",(a)=>this._OnUpdateState(a)),this.AddRuntimeMessageHandler("focus",(a)=>this._OnSetFocus(a)),this.AddRuntimeMessageHandler("set-css-style",(a)=>this._OnSetCssStyle(a))}SetAutoAttach(a){this._autoAttach=!!a}AddDOMElementMessageHandler(a,b){this.AddRuntimeMessageHandler(a,(a)=>{const c=a["elementId"],d=this._elementMap.get(c);return b(d,a)})}_OnCreate(a){const b=a["elementId"],c=this.CreateElement(b,a);this._elementMap.set(b,c),a["isVisible"]||(c.style.display="none"),this._autoAttach&&document.body.appendChild(c)}CreateElement(){throw new Error("required override")}DestroyElement(){}_OnDestroy(a){const b=a["elementId"],c=this._elementMap.get(b);this.DestroyElement(c),this._autoAttach&&c.parentElement.removeChild(c),this._elementMap.delete(b)}PostToRuntimeElement(a,b,c){c||(c={}),c["elementId"]=b,this.PostToRuntime(a,c)}_PostToRuntimeElementMaybeSync(a,b,c){c||(c={}),c["elementId"]=b,this._PostToRuntimeMaybeSync(a,c)}_OnSetVisible(a){if(this._autoAttach){const b=this._elementMap.get(a["elementId"]);b.style.display=a["isVisible"]?"":"none"}}_OnUpdatePosition(a){if(this._autoAttach){const b=this._elementMap.get(a["elementId"]);b.style.left=a["left"]+"px",b.style.top=a["top"]+"px",b.style.width=a["width"]+"px",b.style.height=a["height"]+"px";const c=a["fontSize"];null!==c&&(b.style.fontSize=c+"em")}}_OnUpdateState(a){const b=this._elementMap.get(a["elementId"]);this.UpdateState(b,a)}UpdateState(){throw new Error("required override")}_OnSetFocus(a){const b=this._elementMap.get(a["elementId"]);a["focus"]?b.focus():b.blur()}_OnSetCssStyle(a){const b=this._elementMap.get(a["elementId"]);b.style[a["prop"]]=a["val"]}GetElementById(a){return this._elementMap.get(a)}};

"use strict";{function a(a){return new Promise((b,c)=>{const d=document.createElement("script");d.onload=b,d.onerror=c,d.async=!1,d.src=a,document.head.appendChild(d)})}async function b(a){const b=await c(a),d=new TextDecoder("utf-8");return d.decode(b)}function c(a){return new Promise((b,c)=>{const d=new FileReader;d.onload=(a)=>b(a.target.result),d.onerror=(a)=>c(a),d.readAsArrayBuffer(a)})}function d(a){return o.has(a)}const e=/(iphone|ipod|ipad)/i.test(navigator.userAgent);let f=new Audio;const g={"audio/webm; codecs=opus":!!f.canPlayType("audio/webm; codecs=opus"),"audio/ogg; codecs=opus":!!f.canPlayType("audio/ogg; codecs=opus"),"audio/webm; codecs=vorbis":!!f.canPlayType("audio/webm; codecs=vorbis"),"audio/ogg; codecs=vorbis":!!f.canPlayType("audio/ogg; codecs=vorbis"),"audio/mp4":!!f.canPlayType("audio/mp4"),"audio/mpeg":!!f.canPlayType("audio/mpeg")};f=null;const h=[];let i=0;window["RealFile"]=window["File"];const j=[],k=new Map,l=new Map;let m=0;const n=[];self.runOnStartup=function(a){if("function"!=typeof a)throw new Error("runOnStartup called without a function");n.push(a)};const o=new Set(["cordova","playable-ad","instant-games"]);window.RuntimeInterface=class f{constructor(a){this._useWorker=a.useWorker,this._messageChannelPort=null,this._baseUrl="",this._scriptFolder=a.scriptFolder,this._workerScriptBlobURLs={},this._worker=null,this._localRuntime=null,this._domHandlers=[],this._runtimeDomHandler=null,this._canvas=null,this._jobScheduler=null,this._rafId=-1,this._rafFunc=()=>this._OnRAFCallback(),this._rafCallbacks=[],this._exportType=a.exportType,d(this._exportType)&&this._useWorker&&(console.warn("[C3 runtime] Worker mode is enabled and supported, but is disabled in WebViews due to crbug.com/923007. Reverting to DOM mode."),this._useWorker=!1),this._transferablesBroken=!1,this._localFileBlobs=null,("html5"===this._exportType||"playable-ad"===this._exportType)&&"file"===location.protocol.substr(0,4)&&alert("Exported games won't work until you upload them. (When running on the file: protocol, browsers block many features from working for security reasons.)"),this.AddRuntimeComponentMessageHandler("runtime","cordova-fetch-local-file",(a)=>this._OnCordovaFetchLocalFile(a)),this.AddRuntimeComponentMessageHandler("runtime","create-job-worker",(a)=>this._OnCreateJobWorker(a)),"cordova"===this._exportType?document.addEventListener("deviceready",()=>this._Init(a)):this._Init(a)}Release(){this._CancelAnimationFrame(),this._messageChannelPort&&(this._messageChannelPort.onmessage=null,this._messageChannelPort=null),this._worker&&(this._worker.terminate(),this._worker=null),this._localRuntime&&(this._localRuntime.Release(),this._localRuntime=null),this._canvas&&(this._canvas.parentElement.removeChild(this._canvas),this._canvas=null)}GetCanvas(){return this._canvas}GetBaseURL(){return this._baseUrl}UsesWorker(){return this._useWorker}GetExportType(){return this._exportType}IsiOSCordova(){return e&&"cordova"===this._exportType}IsiOSWebView(){return e&&d(this._exportType)}async _Init(a){if("playable-ad"===this._exportType){this._localFileBlobs=self["c3_base64files"],await this._ConvertDataUrisToBlobs();for(let b=0,c=a.engineScripts.length;b<c;++b){const c=a.engineScripts[b].toLowerCase();this._localFileBlobs.hasOwnProperty(c)&&(a.engineScripts[b]=URL.createObjectURL(this._localFileBlobs[c]))}}if(a.baseUrl)this._baseUrl=a.baseUrl;else{const a=location.origin;this._baseUrl=("null"===a?"file:///":a)+location.pathname;const b=this._baseUrl.lastIndexOf("/");-1!==b&&(this._baseUrl=this._baseUrl.substr(0,b+1))}if(a.workerScripts)for(const[b,c]of Object.entries(a.workerScripts))this._workerScriptBlobURLs[b]=URL.createObjectURL(c);const b=new MessageChannel;this._messageChannelPort=b.port1,this._messageChannelPort.onmessage=(a)=>this["_OnMessageFromRuntime"](a.data),window["c3_addPortMessageHandler"]&&window["c3_addPortMessageHandler"]((a)=>this._OnMessageFromDebugger(a)),this._jobScheduler=new self.JobSchedulerDOM(this),await this._jobScheduler.Init(),this.MaybeForceBodySize(),"object"==typeof window["StatusBar"]&&window["StatusBar"]["hide"](),"object"==typeof window["AndroidFullScreen"]&&window["AndroidFullScreen"]["immersiveMode"](),await this._TestTransferablesWork(),this._useWorker?await this._InitWorker(a,b.port2):await this._InitDOM(a,b.port2)}_GetWorkerURL(a){return this._workerScriptBlobURLs.hasOwnProperty(a)?this._workerScriptBlobURLs[a]:a.endsWith("/workermain.js")&&this._workerScriptBlobURLs.hasOwnProperty("workermain.js")?this._workerScriptBlobURLs["workermain.js"]:"playable-ad"===this._exportType&&this._localFileBlobs.hasOwnProperty(a.toLowerCase())?URL.createObjectURL(this._localFileBlobs[a.toLowerCase()]):a}async CreateWorker(a,b,c){if(a.startsWith("blob:"))return new Worker(a,c);if(this.IsiOSCordova()){const b=await this.CordovaFetchLocalFileAsArrayBuffer(this._scriptFolder+a),d=new Blob([b],{type:"application/javascript"});return new Worker(URL.createObjectURL(d),c)}const d=new URL(a,b),e=location.origin!==d.origin;if(e){const a=await fetch(d);if(!a.ok)throw new Error("failed to fetch worker script");const b=await a.blob();return new Worker(URL.createObjectURL(b),c)}return new Worker(d,c)}MaybeForceBodySize(){if(this.IsiOSWebView()){const a=document["documentElement"].style,b=document["body"].style,c=window.innerWidth<window.innerHeight,d=c?window["screen"]["width"]:window["screen"]["height"],e=c?window["screen"]["height"]:window["screen"]["width"];b["height"]=a["height"]=e+"px",b["width"]=a["width"]=d+"px"}}_GetCommonRuntimeOptions(a){return{"baseUrl":this._baseUrl,"windowInnerWidth":window.innerWidth,"windowInnerHeight":window.innerHeight,"devicePixelRatio":window.devicePixelRatio,"isFullscreen":f.IsDocumentFullscreen(),"projectData":a.projectData,"previewImageBlobs":window["cr_previewImageBlobs"]||this._localFileBlobs,"previewProjectFileBlobs":window["cr_previewProjectFileBlobs"],"exportType":a.exportType,"isDebug":-1<self.location.search.indexOf("debug"),"ife":!!self.ife,"jobScheduler":this._jobScheduler.GetPortData(),"supportedAudioFormats":g,"opusWasmScriptUrl":window["cr_opusWasmScriptUrl"]||this._scriptFolder+"opus.wasm.js","opusWasmBinaryUrl":window["cr_opusWasmBinaryUrl"]||this._scriptFolder+"opus.wasm.wasm","isiOSCordova":this.IsiOSCordova(),"isiOSWebView":this.IsiOSWebView(),"isFBInstantAvailable":"undefined"!=typeof self["FBInstant"]}}async _InitWorker(a,b){const c=this._GetWorkerURL(a.workerMainUrl);this._worker=await this.CreateWorker(c,this._baseUrl,{name:"Runtime"}),this._canvas=document.createElement("canvas"),this._canvas.style.display="none";const d=this._canvas["transferControlToOffscreen"]();document.body.appendChild(this._canvas),window["c3canvas"]=this._canvas,this._worker.postMessage(Object.assign(this._GetCommonRuntimeOptions(a),{"type":"init-runtime","isInWorker":!0,"messagePort":b,"canvas":d,"workerDependencyScripts":a.workerDependencyScripts||[],"engineScripts":a.engineScripts,"projectScripts":window.cr_allProjectScripts,"projectScriptsStatus":self["C3_ProjectScriptsStatus"]}),[b,d,...this._jobScheduler.GetPortTransferables()]),this._domHandlers=j.map((a)=>new a(this)),this._FindRuntimeDOMHandler(),self["c3_callFunction"]=(a,b)=>this._runtimeDomHandler._InvokeFunctionFromJS(a,b),"preview"===this._exportType&&(self["goToLastErrorScript"]=()=>this.PostToRuntimeComponent("runtime","go-to-last-error-script"))}async _InitDOM(b,c){this._canvas=document.createElement("canvas"),this._canvas.style.display="none",document.body.appendChild(this._canvas),window["c3canvas"]=this._canvas,this._domHandlers=j.map((a)=>new a(this)),this._FindRuntimeDOMHandler();const d=b.engineScripts.map((a)=>new URL(a,this._baseUrl).toString());if(Array.isArray(b.workerDependencyScripts)&&d.unshift(...b.workerDependencyScripts),await Promise.all(d.map((b)=>a(b))),b.projectScripts&&0<b.projectScripts.length){const c=self["C3_ProjectScriptsStatus"];try{if(await Promise.all(b.projectScripts.map((b)=>a(b[1]))),Object.values(c).some((a)=>!a))return void self.setTimeout(()=>this._ReportProjectScriptError(c),100)}catch(a){return console.error("[Preview] Error loading project scripts: ",a),void self.setTimeout(()=>this._ReportProjectScriptError(c),100)}}if("preview"===this._exportType&&"object"!=typeof self.C3.ScriptsInEvents){return console.error("[C3 runtime] Failed to load JavaScript code used in events. Check all your JavaScript code has valid syntax."),void alert("Failed to load JavaScript code used in events. Check all your JavaScript code has valid syntax.")}const e=Object.assign(this._GetCommonRuntimeOptions(b),{"isInWorker":!1,"messagePort":c,"canvas":this._canvas,"runOnStartupFunctions":n});this._localRuntime=self["C3_CreateRuntime"](e),await self["C3_InitRuntime"](this._localRuntime,e)}_ReportProjectScriptError(a){const b=Object.entries(a).filter((a)=>!a[1]).map((a)=>a[0]),c=`Failed to load project script '${b[0]}'. Check all your JavaScript code has valid syntax.`;console.error("[Preview] "+c),alert(c)}async _OnCreateJobWorker(){const a=await this._jobScheduler._CreateJobWorker();return{"outputPort":a,"transferables":[a]}}_GetLocalRuntime(){if(this._useWorker)throw new Error("not available in worker mode");return this._localRuntime}PostToRuntimeComponent(a,b,c,d,e){this._messageChannelPort.postMessage({"type":"event","component":a,"handler":b,"dispatchOpts":d||null,"data":c,"responseId":null},this._transferablesBroken?void 0:e)}PostToRuntimeComponentAsync(a,b,c,d,e){const f=m++,g=new Promise((a,b)=>{l.set(f,{resolve:a,reject:b})});return this._messageChannelPort.postMessage({"type":"event","component":a,"handler":b,"dispatchOpts":d||null,"data":c,"responseId":f},this._transferablesBroken?void 0:e),g}["_OnMessageFromRuntime"](a){const b=a["type"];if("event"===b)this._OnEventFromRuntime(a);else if("result"===b)this._OnResultFromRuntime(a);else if("runtime-ready"===b)this._OnRuntimeReady();else if("alert"===b)alert(a["message"]);else throw new Error(`unknown message '${b}'`)}_OnEventFromRuntime(a){const b=a["component"],c=a["handler"],d=a["data"],e=a["responseId"],f=k.get(b);if(!f)return void console.warn(`[DOM] No event handlers for component '${b}'`);const g=f.get(c);if(!g)return void console.warn(`[DOM] No handler '${c}' for component '${b}'`);let h=null;try{h=g(d)}catch(a){return console.error(`Exception in '${b}' handler '${c}':`,a),void(null!==e&&this._PostResultToRuntime(e,!1,a.toString()))}null!==e&&(h&&h.then?h.then((a)=>this._PostResultToRuntime(e,!0,a)).catch((a)=>{console.error(`Rejection from '${b}' handler '${c}':`,a),this._PostResultToRuntime(e,!1,a.toString())}):this._PostResultToRuntime(e,!0,h))}_PostResultToRuntime(a,b,c){let d;c&&c["transferables"]&&(d=c["transferables"]),this._messageChannelPort.postMessage({"type":"result","responseId":a,"isOk":b,"result":c},d)}_OnResultFromRuntime(a){const b=a["responseId"],c=a["isOk"],d=a["result"],e=l.get(b);c?e.resolve(d):e.reject(d),l.delete(b)}AddRuntimeComponentMessageHandler(a,b,c){let d=k.get(a);if(d||(d=new Map,k.set(a,d)),d.has(b))throw new Error(`[DOM] Component '${a}' already has handler '${b}'`);d.set(b,c)}static AddDOMHandlerClass(a){if(j.includes(a))throw new Error("DOM handler already added");j.push(a)}_FindRuntimeDOMHandler(){for(const a of this._domHandlers)if("runtime"===a.GetComponentID())return void(this._runtimeDomHandler=a);throw new Error("cannot find runtime DOM handler")}_OnMessageFromDebugger(a){this.PostToRuntimeComponent("debugger","message",a)}_OnRuntimeReady(){for(const a of this._domHandlers)a.Attach()}static IsDocumentFullscreen(){return!!(document["fullscreenElement"]||document["webkitFullscreenElement"]||document["mozFullScreenElement"])}async GetRemotePreviewStatusInfo(){return await this.PostToRuntimeComponentAsync("runtime","get-remote-preview-status-info")}_AddRAFCallback(a){this._rafCallbacks.push(a),this._RequestAnimationFrame()}_RemoveRAFCallback(a){const b=this._rafCallbacks.indexOf(a);if(-1===b)throw new Error("invalid callback");this._rafCallbacks.splice(b,1),this._rafCallbacks.length||this._CancelAnimationFrame()}_RequestAnimationFrame(){-1===this._rafId&&this._rafCallbacks.length&&(this._rafId=requestAnimationFrame(this._rafFunc))}_CancelAnimationFrame(){-1!==this._rafId&&(cancelAnimationFrame(this._rafId),this._rafId=-1)}_OnRAFCallback(){this._rafId=-1;for(const a of this._rafCallbacks)a();this._RequestAnimationFrame()}TryPlayMedia(a){this._runtimeDomHandler.TryPlayMedia(a)}RemovePendingPlay(a){this._runtimeDomHandler.RemovePendingPlay(a)}_PlayPendingMedia(){this._runtimeDomHandler._PlayPendingMedia()}SetSilent(a){this._runtimeDomHandler.SetSilent(a)}IsAudioFormatSupported(a){return!!g[a]}async _WasmDecodeWebMOpus(a){const b=await this.PostToRuntimeComponentAsync("runtime","opus-decode",{"arrayBuffer":a},null,[a]);return new Float32Array(b)}IsAbsoluteURL(a){return /^(?:[a-z]+:)?\/\//.test(a)||"data:"===a.substr(0,5)||"blob:"===a.substr(0,5)}IsRelativeURL(a){return!this.IsAbsoluteURL(a)}async _OnCordovaFetchLocalFile(a){const b=a["filename"];switch(a["as"]){case"text":return await this.CordovaFetchLocalFileAsText(b);case"buffer":return await this.CordovaFetchLocalFileAsArrayBuffer(b);default:throw new Error("unsupported type");}}_GetPermissionAPI(){const a=window["cordova"]&&window["cordova"]["plugins"]&&window["cordova"]["plugins"]["permissions"];if("object"!=typeof a)throw new Error("Permission API is not loaded");return a}_MapPermissionID(a,b){const c=a[b];if("string"!=typeof c)throw new Error("Invalid permission name");return c}_HasPermission(a){const b=this._GetPermissionAPI();return new Promise((c,d)=>b["checkPermission"](this._MapPermissionID(b,a),(a)=>c(!!a["hasPermission"]),d))}_RequestPermission(a){const b=this._GetPermissionAPI();return new Promise((c,d)=>b["requestPermission"](this._MapPermissionID(b,a),(a)=>c(!!a["hasPermission"]),d))}async RequestPermissions(a){if("cordova"!==this.GetExportType())return!0;if(this.IsiOSCordova())return!0;for(const b of a){const a=await this._HasPermission(b);if(a)continue;const c=await this._RequestPermission(b);if(!1===c)return!1}return!0}async RequirePermissions(...a){if(!1===(await this.RequestPermissions(a)))throw new Error("Permission not granted")}CordovaFetchLocalFile(a){const b=window["cordova"]["file"]["applicationDirectory"]+"www/"+a.toLowerCase();return new Promise((a,c)=>{window["resolveLocalFileSystemURL"](b,(b)=>{b["file"](a,c)},c)})}async CordovaFetchLocalFileAsText(a){const c=await this.CordovaFetchLocalFile(a);return await b(c)}_CordovaMaybeStartNextArrayBufferRead(){if(h.length&&!(i>=8)){i++;const a=h.shift();this._CordovaDoFetchLocalFileAsAsArrayBuffer(a.filename,a.successCallback,a.errorCallback)}}CordovaFetchLocalFileAsArrayBuffer(a){return new Promise((b,c)=>{h.push({filename:a,successCallback:(a)=>{i--,this._CordovaMaybeStartNextArrayBufferRead(),b(a)},errorCallback:(a)=>{i--,this._CordovaMaybeStartNextArrayBufferRead(),c(a)}}),this._CordovaMaybeStartNextArrayBufferRead()})}async _CordovaDoFetchLocalFileAsAsArrayBuffer(a,b,d){try{const d=await this.CordovaFetchLocalFile(a),e=await c(d);b(e)}catch(a){d(a)}}async _ConvertDataUrisToBlobs(){const a=[];for(const[b,c]of Object.entries(this._localFileBlobs))a.push(this._ConvertDataUriToBlobs(b,c));await Promise.all(a)}async _ConvertDataUriToBlobs(a,b){if("object"==typeof b)this._localFileBlobs[a]=new Blob([b["str"]],{"type":b["type"]});else{const c=await fetch(b),d=await c.blob();this._localFileBlobs[a]=d}}_TestTransferablesWork(){let a=null;const b=new Promise((b)=>a=b),c=new ArrayBuffer(1),d=new MessageChannel;return d.port2.onmessage=(b)=>{b.data&&b.data["arrayBuffer"]||(this._transferablesBroken=!0,console.warn("MessageChannel transfers determined to be broken. Disabling transferables.")),a()},d.port1.postMessage({"arrayBuffer":c},[c]),b}}}

"use strict";{function a(a){return a["sourceCapabilities"]&&a["sourceCapabilities"]["firesTouchEvents"]||a["originalEvent"]&&a["originalEvent"]["sourceCapabilities"]&&a["originalEvent"]["sourceCapabilities"]["firesTouchEvents"]}function b(a){return new Promise((b,c)=>{const d=document.createElement("link");d.onload=()=>b(d),d.onerror=(a)=>c(a),d.rel="stylesheet",d.href=a,document.head.appendChild(d)})}function c(a){return new Promise((b,c)=>{const d=new Image;d.onload=()=>b(d),d.onerror=(a)=>c(a),d.src=a})}async function d(a){const b=URL.createObjectURL(a);try{return await c(b)}finally{URL.revokeObjectURL(b)}}function e(a){return new Promise((b,c)=>{let d=new FileReader;d.onload=(a)=>b(a.target.result),d.onerror=(a)=>c(a),d.readAsText(a)})}async function f(a,b,c){if(!/firefox/i.test(navigator.userAgent))return await d(a);let f=await e(a);const g=new DOMParser,h=g.parseFromString(f,"image/svg+xml"),i=h.documentElement;if(i.hasAttribute("width")&&i.hasAttribute("height")){const b=i.getAttribute("width"),c=i.getAttribute("height");if(!b.includes("%")&&!c.includes("%"))return await d(a)}i.setAttribute("width",b+"px"),i.setAttribute("height",c+"px");const j=new XMLSerializer;return f=j.serializeToString(h),a=new Blob([f],{type:"image/svg+xml"}),await d(a)}function g(a){do{if(a.parentNode&&a.hasAttribute("contenteditable"))return!0;a=a.parentNode}while(a);return!1}function h(a){const b=a.target.tagName.toLowerCase();p.has(b)&&a.preventDefault()}function i(a){(a.metaKey||a.ctrlKey)&&a.preventDefault()}function j(){try{return window.parent&&window.parent.document.hasFocus()}catch(a){return!1}}function k(){const a=document.activeElement;if(!a)return!1;const b=a.tagName.toLowerCase(),c=new Set(["email","number","password","search","tel","text","url"]);return!("textarea"!==b)||("input"===b?c.has(a.type.toLowerCase()||"text"):g(a))}const l=new Map([["OSLeft","MetaLeft"],["OSRight","MetaRight"]]),m={"dispatchRuntimeEvent":!0,"dispatchUserScriptEvent":!0},n={"dispatchUserScriptEvent":!0},o={"dispatchRuntimeEvent":!0};const p=new Set(["canvas","body","html"]);self["C3_GetSvgImageSize"]=async function(a){const b=await d(a);if(0<b.width&&0<b.height)return[b.width,b.height];else{b.style.position="absolute",b.style.left="0px",b.style.top="0px",b.style.visibility="hidden",document.body.appendChild(b);const a=b.getBoundingClientRect();return document.body.removeChild(b),[a.width,a.height]}},self["C3_RasterSvgImageBlob"]=async function(a,b,c,d,e){const g=await f(a,b,c),h=document.createElement("canvas");h.width=d,h.height=e;const i=h.getContext("2d");return i.drawImage(g,0,0,b,c),h};let q=!1;document.addEventListener("pause",()=>q=!0),document.addEventListener("resume",()=>q=!1);const r=class extends DOMHandler{constructor(a){super(a,"runtime"),this._isFirstSizeUpdate=!0,this._simulatedResizeTimerId=-1,this._targetOrientation="any",this._attachedDeviceOrientationEvent=!1,this._attachedDeviceMotionEvent=!1,this._debugHighlightElem=null,this._pointerRawUpdateRateLimiter=null,this._lastPointerRawUpdateEvent=null,a.AddRuntimeComponentMessageHandler("canvas","update-size",(a)=>this._OnUpdateCanvasSize(a)),a.AddRuntimeComponentMessageHandler("runtime","invoke-download",(a)=>this._OnInvokeDownload(a)),a.AddRuntimeComponentMessageHandler("runtime","raster-svg-image",(a)=>this._OnRasterSvgImage(a)),a.AddRuntimeComponentMessageHandler("runtime","get-svg-image-size",(a)=>this._OnGetSvgImageSize(a)),a.AddRuntimeComponentMessageHandler("runtime","set-target-orientation",(a)=>this._OnSetTargetOrientation(a)),a.AddRuntimeComponentMessageHandler("runtime","register-sw",()=>this._OnRegisterSW()),a.AddRuntimeComponentMessageHandler("runtime","post-to-debugger",(a)=>this._OnPostToDebugger(a)),a.AddRuntimeComponentMessageHandler("runtime","go-to-script",(a)=>this._OnPostToDebugger(a)),a.AddRuntimeComponentMessageHandler("runtime","before-start-ticking",()=>this._OnBeforeStartTicking()),a.AddRuntimeComponentMessageHandler("runtime","debug-highlight",(a)=>this._OnDebugHighlight(a)),a.AddRuntimeComponentMessageHandler("runtime","enable-device-orientation",()=>this._AttachDeviceOrientationEvent()),a.AddRuntimeComponentMessageHandler("runtime","enable-device-motion",()=>this._AttachDeviceMotionEvent()),a.AddRuntimeComponentMessageHandler("runtime","add-stylesheet",(a)=>this._OnAddStylesheet(a));const b=new Set(["input","textarea","datalist"]);window.addEventListener("contextmenu",(a)=>{const c=a.target,d=c.tagName.toLowerCase();b.has(d)||g(c)||a.preventDefault()}),window.addEventListener("selectstart",h),window.addEventListener("gesturehold",h),window.addEventListener("touchstart",h,{"passive":!1});const c=a.GetCanvas();"undefined"==typeof PointerEvent?c.addEventListener("touchstart",h):(window.addEventListener("pointerdown",h,{"passive":!1}),c.addEventListener("pointerdown",h)),this._mousePointerLastButtons=0,window.addEventListener("mousedown",(a)=>{1===a.button&&a.preventDefault()}),window.addEventListener("mousewheel",i,{"passive":!1}),window.addEventListener("wheel",i,{"passive":!1}),window.addEventListener("resize",()=>this._OnWindowResize()),a.IsiOSWebView()&&window.addEventListener("focusout",()=>{k()||(document.scrollingElement.scrollTop=0)}),this._mediaPendingPlay=new Set,this._mediaRemovedPendingPlay=new WeakSet,this._isSilent=!1}_OnBeforeStartTicking(){return"cordova"===this._iRuntime.GetExportType()?(document.addEventListener("pause",()=>this._OnVisibilityChange(!0)),document.addEventListener("resume",()=>this._OnVisibilityChange(!1))):document.addEventListener("visibilitychange",()=>this._OnVisibilityChange(document.hidden)),{"isSuspended":!!(document.hidden||q)}}Attach(){window.addEventListener("focus",()=>this._PostRuntimeEvent("window-focus")),window.addEventListener("blur",()=>{this._PostRuntimeEvent("window-blur",{"parentHasFocus":j()}),this._mousePointerLastButtons=0}),window.addEventListener("fullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("webkitfullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("mozfullscreenchange",()=>this._OnFullscreenChange()),window.addEventListener("fullscreenerror",(a)=>this._OnFullscreenError(a)),window.addEventListener("webkitfullscreenerror",(a)=>this._OnFullscreenError(a)),window.addEventListener("mozfullscreenerror",(a)=>this._OnFullscreenError(a)),window.addEventListener("keydown",(a)=>this._OnKeyEvent("keydown",a)),window.addEventListener("keyup",(a)=>this._OnKeyEvent("keyup",a)),window.addEventListener("dblclick",(a)=>this._OnMouseEvent("dblclick",a,m)),window.addEventListener("wheel",(a)=>this._OnMouseWheelEvent("wheel",a)),"undefined"==typeof PointerEvent?(window.addEventListener("mousedown",(a)=>this._OnMouseEventAsPointer("pointerdown",a)),window.addEventListener("mousemove",(a)=>this._OnMouseEventAsPointer("pointermove",a)),window.addEventListener("mouseup",(a)=>this._OnMouseEventAsPointer("pointerup",a)),window.addEventListener("touchstart",(a)=>this._OnTouchEvent("pointerdown",a)),window.addEventListener("touchmove",(a)=>this._OnTouchEvent("pointermove",a)),window.addEventListener("touchend",(a)=>this._OnTouchEvent("pointerup",a)),window.addEventListener("touchcancel",(a)=>this._OnTouchEvent("pointercancel",a))):(window.addEventListener("pointerdown",(a)=>this._OnPointerEvent("pointerdown",a)),this._iRuntime.UsesWorker()&&"undefined"!=typeof window["onpointerrawupdate"]?(this._pointerRawUpdateRateLimiter=new RateLimiter(()=>this._DoSendPointerRawUpdate(),5),this._pointerRawUpdateRateLimiter.SetCanRunImmediate(!0),window.addEventListener("pointerrawupdate",(a)=>this._OnPointerRawUpdate(a))):window.addEventListener("pointermove",(a)=>this._OnPointerEvent("pointermove",a)),window.addEventListener("pointerup",(a)=>this._OnPointerEvent("pointerup",a)),window.addEventListener("pointercancel",(a)=>this._OnPointerEvent("pointercancel",a)));const a=()=>this._PlayPendingMedia();window.addEventListener("pointerup",a,!0),window.addEventListener("touchend",a,!0),window.addEventListener("click",a,!0),window.addEventListener("keydown",a,!0),window.addEventListener("gamepadconnected",a,!0)}_PostRuntimeEvent(a,b){this.PostToRuntime(a,b||null,o)}_GetWindowInnerWidth(){return Math.max(window.innerWidth,1)}_GetWindowInnerHeight(){return Math.max(window.innerHeight,1)}_OnWindowResize(){const a=this._GetWindowInnerWidth(),b=this._GetWindowInnerHeight();this._PostRuntimeEvent("window-resize",{"innerWidth":a,"innerHeight":b,"devicePixelRatio":window.devicePixelRatio}),this._iRuntime.IsiOSWebView()&&(-1!==this._simulatedResizeTimerId&&clearTimeout(this._simulatedResizeTimerId),this._OnSimulatedResize(a,b,0))}_ScheduleSimulatedResize(a,b,c){-1!==this._simulatedResizeTimerId&&clearTimeout(this._simulatedResizeTimerId),this._simulatedResizeTimerId=setTimeout(()=>this._OnSimulatedResize(a,b,c),48)}_OnSimulatedResize(a,b,c){const d=this._GetWindowInnerWidth(),e=this._GetWindowInnerHeight();this._simulatedResizeTimerId=-1,d!=a||e!=b?this._PostRuntimeEvent("window-resize",{"innerWidth":d,"innerHeight":e,"devicePixelRatio":window.devicePixelRatio}):10>c&&this._ScheduleSimulatedResize(d,e,c+1)}_OnSetTargetOrientation(a){this._targetOrientation=a["targetOrientation"]}_TrySetTargetOrientation(){const a=this._targetOrientation;if(screen["orientation"]&&screen["orientation"]["lock"])screen["orientation"]["lock"](a).catch((a)=>console.warn("[Construct 3] Failed to lock orientation: ",a));else try{let b=!1;screen["lockOrientation"]?b=screen["lockOrientation"](a):screen["webkitLockOrientation"]?b=screen["webkitLockOrientation"](a):screen["mozLockOrientation"]?b=screen["mozLockOrientation"](a):screen["msLockOrientation"]&&(b=screen["msLockOrientation"](a)),b||console.warn("[Construct 3] Failed to lock orientation")}catch(a){console.warn("[Construct 3] Failed to lock orientation: ",a)}}_OnFullscreenChange(){const a=RuntimeInterface.IsDocumentFullscreen();a&&"any"!==this._targetOrientation&&this._TrySetTargetOrientation(),this.PostToRuntime("fullscreenchange",{"isFullscreen":a,"innerWidth":this._GetWindowInnerWidth(),"innerHeight":this._GetWindowInnerHeight()})}_OnFullscreenError(a){console.warn("[Construct 3] Fullscreen request failed: ",a),this.PostToRuntime("fullscreenerror",{"isFullscreen":RuntimeInterface.IsDocumentFullscreen(),"innerWidth":this._GetWindowInnerWidth(),"innerHeight":this._GetWindowInnerHeight()})}_OnVisibilityChange(a){a?this._iRuntime._CancelAnimationFrame():this._iRuntime._RequestAnimationFrame(),this.PostToRuntime("visibilitychange",{"hidden":a})}_OnKeyEvent(a,b){"Backspace"===b.key&&h(b);const c=l.get(b.code)||b.code;this._PostToRuntimeMaybeSync(a,{"code":c,"key":b.key,"which":b.which,"repeat":b.repeat,"altKey":b.altKey,"ctrlKey":b.ctrlKey,"metaKey":b.metaKey,"shiftKey":b.shiftKey,"timeStamp":b.timeStamp},m)}_OnMouseWheelEvent(a,b){this.PostToRuntime(a,{"clientX":b.clientX,"clientY":b.clientY,"deltaX":b.deltaX,"deltaY":b.deltaY,"deltaZ":b.deltaZ,"deltaMode":b.deltaMode,"timeStamp":b.timeStamp},m)}_OnMouseEvent(b,c,d){a(c)||("mousedown"===b&&window!==window.top&&window.focus(),this._PostToRuntimeMaybeSync(b,{"button":c.button,"buttons":c.buttons,"clientX":c.clientX,"clientY":c.clientY,"timeStamp":c.timeStamp},d))}_OnMouseEventAsPointer(b,c){if(a(c))return;"pointerdown"===b&&window!==window.top&&window.focus();const d=this._mousePointerLastButtons;"pointerdown"===b&&0!==d?b="pointermove":"pointerup"==b&&0!==c.buttons&&(b="pointermove"),this._PostToRuntimeMaybeSync(b,{"pointerId":1,"pointerType":"mouse","button":c.button,"buttons":c.buttons,"lastButtons":d,"clientX":c.clientX,"clientY":c.clientY,"width":0,"height":0,"pressure":0,"tangentialPressure":0,"tiltX":0,"tiltY":0,"twist":0,"timeStamp":c.timeStamp},m),this._mousePointerLastButtons=c.buttons,this._OnMouseEvent(c.type,c,n)}_OnPointerEvent(a,b){"pointerdown"===a&&window!==window.top&&window.focus(),this._pointerRawUpdateRateLimiter&&("pointerup"===a||"pointercancel"===a)&&this._pointerRawUpdateRateLimiter.Reset();let c=0;if("mouse"===b.pointerType&&(c=this._mousePointerLastButtons),this._PostToRuntimeMaybeSync(a,{"pointerId":b.pointerId,"pointerType":b.pointerType,"button":b.button,"buttons":b.buttons,"lastButtons":c,"clientX":b.clientX,"clientY":b.clientY,"width":b.width||0,"height":b.height||0,"pressure":b.pressure||0,"tangentialPressure":b["tangentialPressure"]||0,"tiltX":b.tiltX||0,"tiltY":b.tiltY||0,"twist":b["twist"]||0,"timeStamp":b.timeStamp},m),"mouse"===b.pointerType){let c="mousemove";"pointerdown"===a?c="mousedown":"pointerup"==a&&(c="pointerup"),this._OnMouseEvent(c,b,n),this._mousePointerLastButtons=b.buttons}}_OnPointerRawUpdate(a){this._lastPointerRawUpdateEvent=a,this._pointerRawUpdateRateLimiter.Call()}_DoSendPointerRawUpdate(){this._OnPointerEvent("pointermove",this._lastPointerRawUpdateEvent),this._lastPointerRawUpdateEvent=null}_OnTouchEvent(a,b){"pointerdown"===a&&window!==window.top&&window.focus();for(let c=0,d=b.changedTouches.length;c<d;++c){const d=b.changedTouches[c];this._PostToRuntimeMaybeSync(a,{"pointerId":d.identifier,"pointerType":"touch","button":0,"buttons":0,"lastButtons":0,"clientX":d.clientX,"clientY":d.clientY,"width":2*(d["radiusX"]||d["webkitRadiusX"]||0),"height":2*(d["radiusY"]||d["webkitRadiusY"]||0),"pressure":d["force"]||d["webkitForce"]||0,"tangentialPressure":0,"tiltX":0,"tiltY":0,"twist":d["rotationAngle"]||0,"timeStamp":b.timeStamp},m)}}_AttachDeviceOrientationEvent(){this._attachedDeviceOrientationEvent||(this._attachedDeviceOrientationEvent=!0,window.addEventListener("deviceorientation",(a)=>this._OnDeviceOrientation(a)))}_AttachDeviceMotionEvent(){this._attachedDeviceMotionEvent||(this._attachedDeviceMotionEvent=!0,window.addEventListener("devicemotion",(a)=>this._OnDeviceMotion(a)))}_OnDeviceOrientation(a){this.PostToRuntime("deviceorientation",{"alpha":a["alpha"]||0,"beta":a["beta"]||0,"gamma":a["gamma"]||0,"timeStamp":a.timeStamp},m)}_OnDeviceMotion(a){let b=null;const c=a["acceleration"];c&&(b={"x":c["x"]||0,"y":c["y"]||0,"z":c["z"]||0});let d=null;const e=a["accelerationIncludingGravity"];e&&(d={"x":e["x"]||0,"y":e["y"]||0,"z":e["z"]||0});let f=null;const g=a["rotationRate"];g&&(f={"alpha":g["alpha"]||0,"beta":g["beta"]||0,"gamma":g["gamma"]||0}),this.PostToRuntime("devicemotion",{"acceleration":b,"accelerationIncludingGravity":d,"rotationRate":f,"interval":a["interval"],"timeStamp":a.timeStamp},m)}_OnUpdateCanvasSize(a){const b=this.GetRuntimeInterface(),c=b.GetCanvas();c.style.width=a["styleWidth"]+"px",c.style.height=a["styleHeight"]+"px",c.style.marginLeft=a["marginLeft"]+"px",c.style.marginTop=a["marginTop"]+"px",b.MaybeForceBodySize(),this._isFirstSizeUpdate&&(c.style.display="",this._isFirstSizeUpdate=!1)}_OnInvokeDownload(b){const c=b["url"],d=b["filename"],e=document.createElement("a"),a=document.body;e.textContent=d,e.href=c,e.download=d,a.appendChild(e),e.click(),a.removeChild(e)}async _OnRasterSvgImage(a){const b=a["blob"],c=a["imageWidth"],d=a["imageHeight"],e=a["surfaceWidth"],f=a["surfaceHeight"],g=a["imageBitmapOpts"],h=await self["C3_RasterSvgImageBlob"](b,c,d,e,f);let i;return i=g?await createImageBitmap(h,g):await createImageBitmap(h),{"imageBitmap":i,"transferables":[i]}}async _OnGetSvgImageSize(a){return await self["C3_GetSvgImageSize"](a["blob"])}async _OnAddStylesheet(a){await b(a["url"])}_PlayPendingMedia(){const a=[...this._mediaPendingPlay];if(this._mediaPendingPlay.clear(),!this._isSilent)for(const b of a){const a=b.play();a&&a.catch(()=>{this._mediaRemovedPendingPlay.has(b)||this._mediaPendingPlay.add(b)})}}TryPlayMedia(a){if("function"!=typeof a.play)throw new Error("missing play function");this._mediaRemovedPendingPlay.delete(a);let b;try{b=a.play()}catch(b){return void this._mediaPendingPlay.add(a)}b&&b.catch(()=>{this._mediaRemovedPendingPlay.has(a)||this._mediaPendingPlay.add(a)})}RemovePendingPlay(a){this._mediaPendingPlay.delete(a),this._mediaRemovedPendingPlay.add(a)}SetSilent(a){this._isSilent=!!a}_OnDebugHighlight(a){const b=a["show"];if(!b)return void(this._debugHighlightElem&&(this._debugHighlightElem.style.display="none"));this._debugHighlightElem||(this._debugHighlightElem=document.createElement("div"),this._debugHighlightElem.id="inspectOutline",document.body.appendChild(this._debugHighlightElem));const c=this._debugHighlightElem;c.style.display="",c.style.left=a["left"]-1+"px",c.style.top=a["top"]-1+"px",c.style.width=a["width"]+2+"px",c.style.height=a["height"]+2+"px",c.textContent=a["name"]}_OnRegisterSW(){window["C3_RegisterSW"]&&window["C3_RegisterSW"]()}_OnPostToDebugger(a){window["c3_postToMessagePort"]&&(a["from"]="runtime",window["c3_postToMessagePort"](a))}_InvokeFunctionFromJS(a,b){return this.PostToRuntimeAsync("js-invoke-function",{"name":a,"params":b})}};RuntimeInterface.AddDOMHandlerClass(r)}

"use strict";{const a=document.currentScript.src;self.JobSchedulerDOM=class{constructor(b){this._runtimeInterface=b,this._baseUrl=a?a.substr(0,a.lastIndexOf("/")+1):b.GetBaseURL(),this._maxNumWorkers=Math.min(navigator.hardwareConcurrency||2,16),this._dispatchWorker=null,this._jobWorkers=[],this._inputPort=null,this._outputPort=null}async Init(){if(this._hasInitialised)throw new Error("already initialised");this._hasInitialised=!0;const a=this._runtimeInterface._GetWorkerURL("dispatchworker.js");this._dispatchWorker=await this._runtimeInterface.CreateWorker(a,this._baseUrl,{name:"DispatchWorker"});const b=new MessageChannel;this._inputPort=b.port1,this._dispatchWorker.postMessage({"type":"_init","in-port":b.port2},[b.port2]),this._outputPort=await this._CreateJobWorker()}async _CreateJobWorker(){const a=this._jobWorkers.length,b=this._runtimeInterface._GetWorkerURL("jobworker.js"),c=await this._runtimeInterface.CreateWorker(b,this._baseUrl,{name:"JobWorker"+a}),d=new MessageChannel,e=new MessageChannel;return this._dispatchWorker.postMessage({"type":"_addJobWorker","port":d.port1},[d.port1]),c.postMessage({"type":"init","number":a,"dispatch-port":d.port2,"output-port":e.port2},[d.port2,e.port2]),this._jobWorkers.push(c),e.port1}GetPortData(){return{"inputPort":this._inputPort,"outputPort":this._outputPort,"maxNumWorkers":this._maxNumWorkers}}GetPortTransferables(){return[this._inputPort,this._outputPort]}}}

"use strict";if(window["C3_IsSupported"]){const a=false,b="undefined"!=typeof OffscreenCanvas;window["c3_runtimeInterface"]=new RuntimeInterface({useWorker:a&&b,workerMainUrl:"workermain.js",engineScripts:["scripts/c3runtime.js"],scriptFolder:"scripts/",workerDependencyScripts:[],exportType:"html5"})}"use strict";{function a(a){a.stopPropagation()}const b=class extends DOMElementHandler{constructor(a){super(a,"button")}CreateElement(b,c){const d=document.createElement("input"),e=c["isCheckbox"];let f=d;if(e){d.type="checkbox";const a=document.createElement("label");a.appendChild(d),a.appendChild(document.createTextNode("")),a.style.fontFamily="sans-serif",a.style.userSelect="none",a.style.webkitUserSelect="none",a.style.display="inline-block",a.style.color="black",f=a}else d.type="button";return f.style.position="absolute",f.addEventListener("touchstart",a),f.addEventListener("touchmove",a),f.addEventListener("touchend",a),f.addEventListener("mousedown",a),f.addEventListener("mouseup",a),f.addEventListener("keydown",a),f.addEventListener("keyup",a),d.addEventListener("click",()=>this._PostToRuntimeElementMaybeSync("click",b,{"isChecked":d.checked})),d.id=c["id"],this.UpdateState(f,c),f}_GetInputElem(a){return"input"===a.tagName.toLowerCase()?a:a.firstChild}UpdateState(a,b){const c=this._GetInputElem(a);c.checked=b["isChecked"],c.disabled=!b["isEnabled"],a.title=b["title"],a===c?c.value=b["text"]:a.lastChild.textContent=b["text"]}};RuntimeInterface.AddDOMHandlerClass(b)}"use strict";{function a(a){a.stopPropagation()}function b(a){13!==a.which&&27!==a.which&&a.stopPropagation()}const c=class extends DOMElementHandler{constructor(a){super(a,"text-input"),this.AddDOMElementMessageHandler("scroll-to-bottom",(a)=>this._OnScrollToBottom(a))}CreateElement(c,d){let e;const f=d["type"];return"textarea"===f?(e=document.createElement("textarea"),e.style.resize="none"):(e=document.createElement("input"),e.type=f),e.style.position="absolute",e.autocomplete="off",e.addEventListener("touchstart",a),e.addEventListener("touchmove",a),e.addEventListener("touchend",a),e.addEventListener("mousedown",a),e.addEventListener("mouseup",a),e.addEventListener("keydown",b),e.addEventListener("keyup",b),e.addEventListener("click",(a)=>{a.stopPropagation(),this._PostToRuntimeElementMaybeSync("click",c)}),e.addEventListener("dblclick",(a)=>{a.stopPropagation(),this._PostToRuntimeElementMaybeSync("dblclick",c)}),e.addEventListener("input",()=>this.PostToRuntimeElement("change",c,{"text":e.value})),e.id=d["id"],this.UpdateState(e,d),e}UpdateState(a,b){a.value=b["text"],a.placeholder=b["placeholder"],a.title=b["title"],a.disabled=!b["isEnabled"],a.readOnly=b["isReadOnly"],a.spellcheck=b["spellCheck"]}_OnScrollToBottom(a){a.scrollTop=a.scrollHeight}};RuntimeInterface.AddDOMHandlerClass(c)}"use strict";{function c(b){return b%=i,0>b&&(b+=i),b}function a(c,d,a){return c<d?d:c>a?a:c}function b(c,a,b){return c+b*(a-c)}function d(c,a,b){return c===a?0:(b-c)/(a-c)}function e(a,b){var c=Math.cos,d=Math.sin;if(a===b)return 0;const e=d(a),f=c(a),g=d(b),h=c(b),i=e*g+f*h;return 1<=i?0:-1>=i?Math.PI:Math.acos(i)}function f(a,b){var c=Math.cos,d=Math.sin;const e=d(a),f=c(a),g=d(b),h=c(b);return 0>=f*g-e*h}function g(d,a,b){const g=e(d,a);return f(a,d)?c(d+g*b):c(d-g*b)}const h=[],i=2*Math.PI;class j{constructor(a,b,c,d,e,f){this._index=a,this._interp=b,this._precision=c,this._tag=d,this._userData=e,this._clientValueTag=f}GetRuntimeData(){return{"tag":this._tag,"interp":this._interp,"userData":this._userData,"cvt":this._clientValueTag}}GetIndex(){return this._index}GetInterp(){return this._interp}GetPrecision(){return this._precision}GetTag(){return this._tag}HasUserData(){return"undefined"!=typeof this._userData}GetUserData(){return this._userData}GetClientValueTag(){return this._clientValueTag}Clamp(b){switch(this._precision){case 0:return b;case 1:return Math.fround(b);case 2:return 2===this._interp&&(b=c(b),b/=Math.PI,b-=1,b*=32767),a(0|b,-32768,32767);case 3:return 2===this._interp&&(b=c(b),b/=i,b*=255),a(0|b,0,255);default:return b;}}Write(a,b,c){switch(this._precision){case 0:a.setFloat64(b,c),b+=8;break;case 1:a.setFloat32(b,c),b+=4;break;case 2:a.setInt16(b,c),b+=2;break;case 3:a.setUint8(b,c),b+=1;break;default:a.setFloat32(b,c),b+=4;}return b}MaybeUnpack(a){return 2===this._interp?2===this._precision?(a/=32767,a+=1,a*=Math.PI,a):3===this._precision?(a/=255,a*=i,a):a:a}static InterpNetValue(a,c,d,e,f){return 0===a?f?d:c:1===a?b(c,d,e):2===a?g(c,d,e):f?d:c}}class k{constructor(a,b){this.timestamp=a,this.data=b}}class l{constructor(a,b,c){this._ro=a,this._domHandler=a.GetDOMHandler(),this._id=b,this._nid=c,this._data=[],this._data.length=this._ro.GetNetValues().length,this._lastChanged=0,this._lastTransmitted=0,this._transmitMe=!1,this._isAlive=!1,this._updates=[],this._priorUpdate2=null,this._priorUpdate=null,this._nextUpdate=null}GetRuntimeData(){const a=[];for(let b=0,c=this._ro.GetNetValues().length;b<c;++b)a.push(this.GetInterp(this._ro.GetSimTime(),b));const b={"id":this._id,"nid":this._nid,"isTimedOut":this.IsTimedOut(),"interpValues":a,"latestUpdate":null},c=this.GetLatestUpdate();return c&&(b["latestUpdate"]={"timestamp":c.timestamp,"data":c.data}),b}GetId(){return this._id}GetNid(){return this._nid}SetAlive(b){this._isAlive=!!b}IsAlive(){return this._isAlive}ShouldTransmit(){return this._transmitMe}UpdateData(a,b){const c=a["netValues"],d=this._ro.GetNetValues(),e=d.length;this._transmitMe=!1;for(let f=0;f<e;++f){const a=d[f],e=a.Clamp(c[f]);this._data[f]!==e&&(this._data[f]=e,this._lastChanged=b,this._ro.SetLastChanged(b))}const f=b-this._lastChanged,g=b-this._lastTransmitted,h=this._ro.GetBandwidth();this._transmitMe=!!(100>f&&0===h)||(1e3>f&&1>=h?95<=g:495<=g),this._transmitMe&&this._ro.IncNumberToTransmit()}WriteData(a,b,c){const d=this._ro.GetNetValues();this._lastTransmitted=c,a.setUint16(b,this._nid),b+=2;for(let e=0,f=this._data.length;e<f;++e)b=d[e].Write(a,b,this._data[e]);return b}AddUpdate(a,b){for(let c=0,d=this._updates.length;c<d;++c){const d=this._updates[c];if(d.timestamp===a)return;if(d.timestamp>a)return void this._updates.splice(c,0,new k(a,b))}this._updates.push(new k(a,b))}IsTimedOut(){return 0!==this._updates.length&&this._updates[this._updates.length-1].timestamp<this._ro.GetSimTime()-3e3}Tick(){for(;2<this._updates.length&&this._updates[0]!==this._priorUpdate2&&this._updates[0]!==this._priorUpdate&&this._updates[0]!==this._nextUpdate;)this._updates.shift();const a=this._ro.GetSimTime();if(!(this._nextUpdate&&this._nextUpdate.timestamp>a&&this._priorUpdate&&this._priorUpdate.timestamp<a)){this._nextUpdate=null;for(let b=0,c=this._updates.length;b<c;++b){const c=this._updates[b];if(c.timestamp<=a)(!this._priorUpdate||c.timestamp>this._priorUpdate.timestamp)&&(this._priorUpdate2=this._priorUpdate,this._priorUpdate=c);else{this._nextUpdate=c;break}}}}GetLatestUpdate(){return 0===this._updates.length?null:this._updates[this._updates.length-1]}GetInterp(a,b,c){if(!this._nextUpdate&&!this._priorUpdate)return 0;if(this._nextUpdate&&!this._priorUpdate)return this._nextUpdate.data[b];const e=this._ro.GetNetValues();let f,g,h,i,k;if(!this._nextUpdate&&this._priorUpdate){if(this._priorUpdate2&&!c){f=this._priorUpdate2.timestamp,g=this._priorUpdate2.data[b],h=this._priorUpdate.timestamp,i=this._priorUpdate.data[b];let c=a;return c>this._priorUpdate.timestamp+this._ro.GetExtrapolateLimit()&&(c=this._priorUpdate.timestamp+this._ro.GetExtrapolateLimit()),k=d(f,h,c),j.InterpNetValue(e[b].GetInterp(),g,i,k,!0)}return this._priorUpdate.data[b]}return f=this._priorUpdate.timestamp,g=this._priorUpdate.data[b],h=this._nextUpdate.timestamp,i=this._nextUpdate.data[b],k=d(f,h,a),j.InterpNetValue(e[b].GetInterp(),g,i,k,!1)}}self.C3NetValue=j,self.C3NetUpdate=k,self.C3RegisteredObject=class{constructor(a,b,c,d){switch(this._domHandler=a,this._roId=b,this._sid=c,this._nid=this._domHandler.GetNextObjectNid(),this._bandwidth=d,this._userData={},this._instanceByteSize=0,this._extrapolateLimit=250,this._bandwidth){case 1:this._extrapolateLimit=500;break;case 2:this._extrapolateLimit=2500;}this._netValues=[],this._netInstances=[],this._idToNetInst=new Map,this._usedNids=new Set,this._nextNid=0,this._lastChanged=0,this._lastTransmitted=0,this._numberToTransmit=0,this._hasOverriddenNids=!1,this._deadNids=[],this._overrideNids=new Map,this._nidToNetInst=new Map,this._simTime=0,this._domHandler.AddRegisteredObject(this)}GetDOMHandler(){return this._domHandler}GetNetValues(){return this._netValues}GetRoId(){return this._roId}_SetNid(a){this._nid=a}GetNid(){return this._nid}SetLastChanged(a){this._lastChanged=a}GetBandwidth(){return this._bandwidth}IncNumberToTransmit(){this._numberToTransmit++}GetNumberToTransmit(){return this._numberToTransmit}GetSimTime(){return this._simTime}_SetHasOverriddenNids(a){this._hasOverriddenNids=!!a}HasOverriddenNids(){return this._hasOverriddenNids}GetExtrapolateLimit(){return this._extrapolateLimit}GetSid(){return this._sid}GetDeadNids(){return this._deadNids}AddValue(a,b,c,d,e){const f=new j(this._netValues.length,a,b,c,d,e);0===b?this._instanceByteSize+=8:1===b?this._instanceByteSize+=4:2===b?this._instanceByteSize+=2:3===b?this._instanceByteSize+=1:void 0;this._netValues.push(f)}AddUpdate(a,b,c){const d=this.GetNetInstForNid(b);d.AddUpdate(a,c)}Tick(){this._simTime=this._domHandler.GetSimulationTime();for(const a of this._netInstances)a.Tick()}GetCount(){return this._netInstances.length}GetNetInstAt(a){return a=Math.floor(a),0>a||a>=this._netInstances.length?null:this._netInstances[a]}GetNetInstByNid(a){for(const b of this._netInstances)if(b.GetNid()===a)return b;return null}GetNetValuesJson(){const a=[];for(const b of this._netValues){const c={"tag":b.GetTag(),"precision":b.GetPrecision(),"interp":b.GetInterp(),"clientvaluetag":b.GetClientValueTag()};b.HasUserData()&&(c["userdata"]=b.GetUserData()),a.push(c)}return a}SetNetValuesFrom(a){this._netValues.length=0,this._instanceByteSize=0;for(const b of a)this.AddValue(b["interp"],b["precision"],b["tag"],b["userdata"],b["clientvaluetag"])}GetNetInstForNid(a){let b=this._nidToNetInst.get(a);return b?b:(b=new l(this,-1,a),this._nidToNetInst.set(a,b),this._netInstances.push(b),b)}GetNetInstForId(a){let b=this._idToNetInst.get(a);return b?b:(b=new l(this,a,this.AllocateInstanceNid()),this._idToNetInst.set(a,b),this._netInstances.push(b),b)}AllocateInstanceNid(){do this._nextNid++,65535<this._nextNid&&(this._nextNid=0);while(this._usedNids.has(this._nextNid));const a=this._nextNid;return this._usedNids.add(a),a}RemoveNetInstance(a){const b=a.GetId(),c=a.GetNid();this._domHandler.IsHost()&&!this._hasOverriddenNids&&this._deadNids.push(c),this._idToNetInst.delete(b),this._nidToNetInst.delete(c),this._usedNids.delete(c);const d=this._netInstances.indexOf(a);-1<d&&this._netInstances.splice(d,1)}UpdateData(a,b){this._numberToTransmit=0;for(const c of this._netInstances)c.SetAlive(!1);for(let c=0,d=a.length;c<d;++c){const e=a[c],d=e["uid"],f=this.GetNetInstForId(d);f.SetAlive(!0),f.UpdateData(e,b)}for(const c of this._netInstances)c.IsAlive()||h.push(c);for(const c of h)this.RemoveNetInstance(c);h.length=0}WriteData(a,b,c){a.setUint16(b,this._nid),b+=2;let d=0;this._hasOverriddenNids&&(d=1),a.setUint8(b,d),b+=1,a.setUint16(b,this._numberToTransmit),b+=2,a.setUint16(b,this._instanceByteSize),b+=2;for(const d of this._netInstances)d.ShouldTransmit()&&(b=d.WriteData(a,b,c));return b}OverrideNid(a,b){if(this._idToNetInst.has(a))return void console.warn("OverrideNid passed id "+a+" which is already in use and cannot be overridden");if(this._usedNids.has(b))return void console.warn("OverrideNid passed nid "+b+" which is already in use and cannot be overridden");const c=new l(this,a,b);return this._idToNetInst.set(a,c),this._usedNids.add(b),this._netInstances.push(c),this._hasOverriddenNids=!0,c}RemoveObjectId(a){const b=this._idToNetInst.get(a);b&&this.RemoveNetInstance(b)}RemoveObjectNid(a){const b=this._nidToNetInst.get(a);b&&this.RemoveNetInstance(b)}GetRuntimeData(){return{"hasOverriddenNids":this.HasOverriddenNids(),"netValues":this._netValues.map((a)=>a.GetRuntimeData()),"netInstances":this._netInstances.map((a)=>a.GetRuntimeData())}}GetRuntimeInfoRequest(){return{"roId":this._roId,"sid":this._sid,"netValues":this._netValues.map((a)=>a.GetRuntimeData())}}}}"use strict";{function a(a){if(a)try{a.close()}catch(a){}}function b(c,a,b){return c===a?0:(b-c)/(a-c)}const c=window["RTCPeerConnection"]||window["webkitRTCPeerConnection"]||window["mozRTCPeerConnection"]||window["msRTCPeerConnection"],d=[];class e{constructor(a,b,c){this._domHandler=a,this._id=b,this._nid=0,this._alias=c,this._pc=null,this._dco=null,this._isOOpen=!1,this._dcr=null,this._isROpen=!1,this._dcu=null,this._isUOpen=!1,this._firedOpen=!1,this._firedClose=!1,this._wasRemoved=!1,this._hasConfirmed=!1,this._lastHeardFrom=0,this._connectTime=0,this._errorCount=0,this._localClientState=[],this._lastStateChange=0,this._lastStateTransmit=0,this._clientStateUpdates=[],this._priorUpdate2=null,this._priorUpdate=null,this._nextUpdate=null,this._lastPingSent=0,this._awaitingPong=!1,this._lastSentPingId=1,this._lastPingTimes=[],this._latency=0,this._pdv=0,this._domHandler._AddPeer(this)}GetId(){return this._id}GetNid(){return this._nid}_SetNid(a){this._nid=a}GetAlias(){return this._alias}IsHost(){return this===this._domHandler.GetHostPeer()}IsSelf(){return this===this._domHandler.GetSelfPeer()}GetLocalClientState(){return this._localClientState}_SetLastStateChange(a){this._lastStateChange=a}GetLastStateChange(){return this._lastStateChange}_SetLastStateTransmit(a){this._lastStateTransmit=a}GetLastStateTransmit(){return this._lastStateTransmit}GetLatency(){return this._latency}GetPdv(){return this._pdv}_AttachDataChannelHandlers(a,b){a.binaryType="arraybuffer",a.onopen=()=>{"o"===b?this._isOOpen=!0:"r"===b?this._isROpen=!0:"u"==b&&(this._isUOpen=!0),this._MaybeFireOpen()},a.onmessage=(a)=>{this._OnMessage(b,a)},a.onerror=(a)=>{console.error("Peer '"+this._id+"' datachannel '"+b+"' error: ",a),this._domHandler._OnPeerError(this,a),this._domHandler.IsHost()&&!this.IsHost()&&this.Remove("network error")},a.onclose=()=>{this.Remove("disconnect")}}Connect(){if(this.IsSelf())return;const a=this._domHandler.IsHost();this._isOOpen=!1,this._isROpen=!1,this._isUOpen=!1,this._firedOpen=!1,this._firedClose=!1,this._connectTime=performance.now(),this._pc=new c({"iceServers":this._domHandler.GetICEServerList()}),this._pc.onicecandidate=(a)=>{a.candidate&&this._domHandler.SignallingSend({"message":"icecandidate","toclientid":this._id,"icecandidate":a.candidate})},this._pc.onsignalingstatechange=()=>{this._pc&&("closed"!==this._pc.signalingState||this.Remove("disconnect"))},this._pc.oniceconnectionstatechange=()=>{this._pc&&("failed"!==this._pc.iceConnectionState&&"closed"!==this._pc.iceConnectionState||this.Remove("disconnect"))},this._pc["onconnectionstatechange"]=()=>{if(this._pc){const a=this._pc["connectionState"];("failed"===a||"closed"===a)&&this.Remove("disconnect")}};const b=`c2mp_${this._domHandler.GetCurrentGame()}_${this._domHandler.GetCurrentGameInstance()}_${this._domHandler.GetCurrentRoom()}`;a?(this._nid=this._domHandler.AllocatePeerNid(),this._dco=this._pc.createDataChannel("o",{ordered:!0,protocol:b}),this._AttachDataChannelHandlers(this._dco,"o"),this._dcr=this._pc.createDataChannel("r",{ordered:!1,protocol:b}),this._AttachDataChannelHandlers(this._dcr,"r"),this._dcu=this._pc.createDataChannel("u",{ordered:!1,maxRetransmits:0,protocol:b}),this._AttachDataChannelHandlers(this._dcu,"u"),this._pc.createOffer().then((a)=>{this._pc.setLocalDescription(a),this._domHandler.SignallingSend({"message":"offer","toclientid":this._id,"offer":a})}).catch((a)=>{console.error("Host error creating offer for peer '"+this._id+"': ",a),this._domHandler._OnPeerError(this,"could not create offer for peer")})):this._pc.ondatachannel=(a)=>{if(a.channel.protocol!==b)return console.error("Unexpected datachannel protocol '"+a.channel.protocol+"', should be '"+expect_protocol+"'"),void this._domHandler._OnPeerError(this,"unexpected datachannel protocol '"+a.channel.protocol+"', should be '"+expect_protocol+"'");const c=a.channel.label;"o"===c?this._dco=a.channel:"r"===c?this._dcr=a.channel:"u"===c?this._dcu=a.channel:(console.error("Unknown datachannel label: "+a.channel.label),this._domHandler._OnPeerError(this,"unknown datachannel label '"+a.channel.label+"'")),this._AttachDataChannelHandlers(a.channel,c)}}async _AddICECandidate(a){if(this._pc)try{await this._pc.addIceCandidate(a)}catch(a){console.warn("[Multiplayer] Error adding ICE candidate: ",a)}}HasPeerConnection(){return!!this._pc}GetPeerConnection(){return this._pc}_MaybeFireOpen(){this._firedOpen||this._isROpen&&this._isUOpen&&this._isOOpen&&(this._OnOpen(),this._firedOpen=!0,this._firedClose=!1)}_OnOpen(){if(this._lastHeardFrom=performance.now(),this._domHandler.IsHost()){this._domHandler.HostBroadcast("o",JSON.stringify({"c":"j","i":this._id,"n":this._nid,"a":this._alias}),this),this.Send("o",JSON.stringify({"c":"hi","hn":this._domHandler.GetHostPeer().GetNid(),"n":this._nid,"d":this._domHandler.GetClientDelay(),"u":this._domHandler.GetPeerUpdateRateSec(),"objs":this._domHandler.GetRegisteredObjectsMap(),"cvs":this._domHandler.GetClientValuesJson()}));for(const a of this._domHandler.peers())!a.IsHost()&&a!==this&&a.IsOpen()&&this.Send("o",JSON.stringify({"c":"j","i":a.GetId(),"n":a.GetNid(),"a":a.GetAlias()}))}else this._hasConfirmed=!0,this.IsHost()&&this.SendPing(performance.now(),!0);this._domHandler._OnPeerOpen(this)}_MaybeFireClose(a){this._firedClose||!this._firedOpen||(this._OnClose(a),this._firedClose=!0,this._firedOpen=!1)}_OnClose(a){this._domHandler.IsHost()&&!this.IsSelf()&&this._domHandler.HostBroadcast("o",JSON.stringify({"c":"l","i":this._id,"a":this._alias,"r":a}),this),this.IsSelf()||this._domHandler._OnPeerClose(this,a)}IsOpen(){return this._firedOpen&&!this._firedClose}Send(a,b){this._domHandler.StatIncOutboundCount();let c=0;b.length?c=b.length:b.byteLength&&(c=b.byteLength),this._domHandler.StatAddOutboundBandwidthCount(c);const d=this._domHandler.GetSimulatedPacketLoss(),e=this._domHandler.GetSimulatedLatency(),f=this._domHandler.GetSimulatedPdv();if(!(0<d&&"u"===a&&Math.random()<d))if(0===e&&0===f)this._DoSend(a,b);else{let c=1;"u"!==a&&Math.random()<d&&(c=3),setTimeout(()=>this._DoSend(a,b),e*c+Math.random()*f*c)}}_DoSend(a,b){try{"o"===a?this._isOOpen&&this._dco&&this._dco.send(b):"r"===a?this._isROpen&&this._dcr&&this._dcr.send(b):"u"==a&&this._isUOpen&&this._dcu&&this._dcu.send(b)}catch(c){if(this._wasRemoved)return;this._domHandler.IsHost()?"o"===a||"r"===a?("string"==typeof b?(console.error("Error sending "+b.length+"-char string on '"+a+"' to '"+this._alias+"', host kicking: ",c),console.log("String that failed to send from previous error was: "+b)):console.error("Error sending "+(b.length||b.byteLength)+"-byte binary on '"+a+"' to '"+this._alias+"', host kicking: ",c),this.Remove("network error")):(this._errorCount++,10<=this._errorCount&&("string"==typeof b?(console.error("Too many errors ("+this._errorCount+") sending data on '"+a+"' to '"+this._alias+"', kicking; last error was for sending "+b.length+"-char string: ",c),console.log("String that failed to send from previous error was: "+b)):console.error("Too many errors ("+this._errorCount+") sending data on '"+a+"' to '"+this._alias+"', kicking; last error was for sending "+(b.length||b.byteLength)+"-byte binary: ",c),this.Remove("network error"))):console.error("Error sending data on '"+a+"': ",c)}}SendPing(a,b){return this._wasRemoved?void 0:!b&&!this.IsOpen()&&this._pc&&25e3<a-this._connectTime?(console.warn("Timed out '"+this._alias+"', could not establish connection after 25sec"),void this.Remove("timeout")):!b&&this.IsOpen()&&2e4<a-this._lastHeardFrom?(console.warn("Timed out '"+this._alias+"', not heard from for 20sec"),void this.Remove("timeout")):void(this._lastPingSent=a,this._awaitingPong=!0,this._lastSentPingId++,this.Send("u","ping:"+this._lastSentPingId))}SendPong(a){let b="pong:"+a.substr(5);this._domHandler.IsHost()&&(b+="/",b+=Math.round(performance.now()).toString()),this.Send("u",b)}_OnPong(a){if(!this._awaitingPong)return;const b=a.indexOf(":");if(-1<b){const c=parseFloat(a.substr(b+1));if(c!==this._lastSentPingId)return}else return void console.warn("Cannot parse off ping ID from pong");const c=performance.now();this._awaitingPong=!1;const e=(c-this._lastPingSent)/2;this._lastPingTimes.push(e),10<this._lastPingTimes.length&&this._lastPingTimes.shift(),d.push(...this._lastPingTimes),d.sort((c,a)=>c-a),this._pdv=d[d.length-1]-d[0];let f=0,g=d.length;4<=d.length&&6>=d.length?(++f,--g):6<d.length&&(f+=2,g-=2);let h=0;for(let b=f;b<g;++b)h+=d[b];if(this._latency=h/(g-f),d.length=0,!this._domHandler.IsHost()){const b=a.indexOf("/");if(-1<b){const d=parseFloat(a.substr(b+1));isFinite(d)?this._domHandler.AddHostTime(d,c,e,this._latency):console.warn("Invalid host time from pong response")}else console.warn("Cannot parse off host time from pong response")}}_OnMessage(a,b){const c=this._domHandler.GetSimulatedPacketLoss(),d=this._domHandler.GetSimulatedLatency(),e=this._domHandler.GetSimulatedPdv();if(!(0<c&&"u"===a&&Math.random()<c))if(0===d&&0===e)this._DoOnMessage(a,b);else{let f=1;"u"!==a&&Math.random()<c&&(f=3),setTimeout(()=>this._DoOnMessage(a,b),d*f+Math.random()*e*f)}}_DoOnMessage(a,b){if(this._wasRemoved)return;this._lastHeardFrom=performance.now(),this._domHandler.StatIncInboundCount();let c=0;if(b.data.length?c=b.data.length:b.data.byteLength&&(c=b.data.byteLength),this._domHandler.StatAddInboundBandwidthCount(c),"string"==typeof b.data){if(""===b.data.trim()||4>b.data.length)return;const a=b.data.substr(0,4);if("ping"===a)return void this.SendPong(b.data);if("pong"===a)return void this._OnPong(b.data);var d;try{d=JSON.parse(b.data)}catch(a){return this._domHandler._OnPeerError(this,a),this._domHandler.IsHost()?(console.error("Error parsing message as JSON for peer '"+this._id+"', host kicking: ",a),this.Remove("data error")):console.error("Error parsing message as JSON for peer '"+this._id+"': ",a),void console.log("String that failed to parse from previous error: "+b.data)}if(!d)return;try{d["c"]&&"m"!==d["c"]?this._OnControlMessage(d):this._domHandler._OnPeerMessage(this,d)}catch(a){this._domHandler._OnPeerError(this,a),this._domHandler.IsHost()?(console.error("Error handling message for peer '"+this._id+"', host kicking: ",a),this.Remove("data error")):console.error("Error handling message for peer '"+this._id+"': ",a)}return}!this._hasConfirmed&&this._domHandler.IsHost()&&"u"===a&&(this._hasConfirmed=!0,this._domHandler.SignallingConfirmPeer(this._id));try{this._OnBinaryMessage(b.data)}catch(a){return this._domHandler._OnPeerError(this,a),void(this._domHandler.IsHost()?(console.error("Error handling binary update for peer '"+this._id+"', host kicking: ",a),this.Remove("data error")):console.error("Error handling binary update for peer '"+this._id+"': ",a))}}_OnControlMessage(a){let b,c;switch(a["c"]){case"disconnect":a["k"]&&this._domHandler.PostToRuntime("peer-kicked"),c=!this._domHandler.IsHost()&&!this.IsHost(),this.Remove(a["r"]),c&&this._domHandler.SignallingLeaveRoom();break;case"hi":this._domHandler.IsHost()||(this._domHandler.GetHostPeer()._SetNid(a["hn"]),this._domHandler.GetSelfPeer()._SetNid(a["n"]),this._domHandler.SetClientDelay(a["d"]),this._domHandler.SetPeerUpdateRateSec(a["u"]),this._domHandler.MapObjectNids(a["objs"]),this._domHandler.MapClientValues(a["cvs"]));break;case"j":this._domHandler.IsHost()||(b=new e(this._domHandler,a["i"],a["a"]),b._SetNid(a["n"]),this._domHandler._OnPeerOpen(b));break;case"l":this._domHandler.IsHost()||(b=this._domHandler.GetPeerById(a["i"]),b&&(!b.IsSelf()&&this._domHandler._OnPeerClose(b,a["r"]),b.Remove(a["r"])));break;default:console.error("Unknown control message from peer '"+this._id+"': "+a["c"]),this._domHandler._OnPeerError(this,"unknown control message '"+a["c"]+"'");}}_OnBinaryMessage(a){this._domHandler.IsHost()?this._OnHostUpdate(a):this._OnPeerUpdate(a)}_OnHostUpdate(a){const b=new DataView(a);let c=0;const d=b.getUint32(c);if(c+=4,1664249200!==d)return void console.warn("Rejected packet with incorrect magic number (received '"+d+"', expected '"+1664249200+"'");let e=b.getFloat64(c);if(c+=8,e+=this._latency,!(3e3<=Math.abs(e-performance.now()))){b.getUint8(c);c+=1;const a=b.getUint8(c);c+=1;const d=[],f=this._domHandler.GetClientValues();for(let e=0;e<a;++e){if(e>=f.length){d.push(0);continue}const a=f[e];let g=0;switch(a.GetPrecision()){case 0:g=b.getFloat64(c),c+=8;break;case 1:g=b.getFloat32(c),c+=4;break;case 2:g=a.MaybeUnpack(b.getInt16(c)),c+=2;break;case 3:g=a.MaybeUnpack(b.getUint8(c)),c+=1;break;default:g=b.getFloat32(c),c+=4;}d.push(g)}this._AddClientUpdate(e,d)}}_AddClientUpdate(a,b){for(let c=0,d=this._clientStateUpdates.length;c<d;++c){const d=this._clientStateUpdates[c];if(d.timestamp===a)return;if(d.timestamp>a)return void this._clientStateUpdates.splice(c,0,new C3NetUpdate(a,b))}this._clientStateUpdates.push(new C3NetUpdate(a,b))}Tick(a){if(0!==this._clientStateUpdates.length){for(;2<this._clientStateUpdates.length&&this._clientStateUpdates[0]!==this._priorUpdate2&&this._clientStateUpdates[0]!==this._priorUpdate&&this._clientStateUpdates[0]!==this._nextUpdate;)this._clientStateUpdates.shift();if(!(this._nextUpdate&&this._nextUpdate.timestamp>a&&this._priorUpdate&&this._priorUpdate.timestamp<a)){this._nextUpdate=null;for(let b=0,c=this._clientStateUpdates.length;b<c;++b){const c=this._clientStateUpdates[b];if(c.timestamp<=a)(!this._priorUpdate||c.timestamp>this._priorUpdate.timestamp)&&(this._priorUpdate2=this._priorUpdate,this._priorUpdate=c);else{this._nextUpdate=c;break}}}}}_OnPeerUpdate(a){const b=new DataView(a);let c=0;const d=b.getUint32(c);if(c+=4,1664249200!==d)return void console.warn("Rejected packet with incorrect magic number (received '"+d+"', expected '"+1664249200+"'");const e=b.getUint32(c);c+=4,0===e?this._HandlePeerUpdate(b,c):1===e?this._HandlePeerEvents(b,c):console.warn("Ignoring packet with incorrect flags (received "+e+", expected 0 or 1")}_HandlePeerUpdate(a,b){const c=a.getFloat64(b);b+=8;const d=a.getUint16(b);b+=2;for(let e=0;e<d;++e){const d=a.getUint16(b);b+=2;const e=a.getUint8(b);b+=1;let f=null,g=0;const h=this._domHandler.GetRegisteredObjectByNid(d);h?(f=h.GetNetValues(),g=f.length,1===e&&h._SetHasOverriddenNids(!0)):console.warn("Don't know which object corresponds to NID "+d);const i=a.getUint16(b);b+=2;const j=a.getUint16(b);b+=2;for(let d=0;d<i;++d){const d=a.getUint16(b);if(b+=2,h){const e=[];let i=b;for(let b=0;b<g;++b){const c=f[b];let d=0;switch(c.GetPrecision()){case 0:d=a.getFloat64(i),i+=8;break;case 1:d=a.getFloat32(i),i+=4;break;case 2:d=c.MaybeUnpack(a.getInt16(i)),i+=2;break;case 3:d=c.MaybeUnpack(a.getUint8(i)),i+=1;break;default:d=a.getFloat32(i),i+=4;}e.push(d)}h.AddUpdate(c,d,e)}b+=j}}}_HandlePeerEvents(a,b){const c=a.getFloat64(b);b+=8;const d=a.getUint16(b);b+=2;for(let e=0;e<d;++e){const d=a.getUint16(b);b+=2;const e=this._domHandler.GetRegisteredObjectByNid(d);e||console.warn("Don't know which object corresponds to NID "+ro_nid);const f=a.getUint16(b);b+=2;for(let d=0;d<f;++d){const d=a.getUint16(b);b+=2,e&&!e.HasOverriddenNids()&&(this._domHandler._OnInstanceDestroyed(e,d,c),e.RemoveObjectNid(d))}}}Remove(b,c){this._wasRemoved||(this._wasRemoved=!0,this._MaybeFireClose(b),this.Send("o",JSON.stringify({"c":"disconnect","r":b,"k":!!c})),a(this._dco),a(this._dcr),a(this._dcu),a(this._pc),this._dco=null,this._dcr=null,this._dcu=null,this._pc=null,this._isOOpen=!1,this._isROpen=!1,this._isUOpen=!1,this._domHandler._RemovePeer(this))}HasClientState(a){return this._domHandler.HasClientValueTag(a)}GetClientState(a){const b=this._domHandler.GetClientValueByTag(a);if(!b)return 0;const c=b.GetIndex();if(0===this._clientStateUpdates.length)return 0;const d=this._clientStateUpdates[this._clientStateUpdates.length-1].data;return 0>c||c>=d.length?0:d[c]}GetInterpClientState(a){const c=a.GetIndex();if(!this._nextUpdate&&!this._priorUpdate)return 0;if(this._nextUpdate&&!this._priorUpdate){const a=this._nextUpdate.data;return 0>c||c>=a.length?0:a[c]}const d=this._domHandler.GetSimulationTime();let e,f,g,h,i;if(!this._nextUpdate&&this._priorUpdate)if(this._priorUpdate2){e=this._priorUpdate2.timestamp,f=this._priorUpdate2.data[c],g=this._priorUpdate.timestamp,h=this._priorUpdate.data[c];let a=d;return a>this._priorUpdate.timestamp+250&&(a=this._priorUpdate.timestamp+250),i=b(e,g,a),C3NetValue.InterpNetValue(this._domHandler.GetClientValues()[c].GetInterp(),f,h,i,!0)}else{const a=this._priorUpdate.data;return 0>c||c>=a.length?0:a[c]}return e=this._priorUpdate.timestamp,f=this._priorUpdate.data[c],g=this._nextUpdate.timestamp,h=this._nextUpdate.data[c],i=b(e,g,d),C3NetValue.InterpNetValue(this._domHandler.GetClientValues()[c].GetInterp(),f,h,i,!1)}}self.C3Peer=e}"use strict";{const a=window["RTCPeerConnection"]||window["webkitRTCPeerConnection"]||window["mozRTCPeerConnection"]||window["msRTCPeerConnection"],b=window["RTCSessionDescription"]||window["webkitRTCSessionDescription"]||window["mozRTCSessionDescription"]||window["msRTCSessionDescription"],c=window["RTCIceCandidate"]||window["webkitRTCIceCandidate"]||window["mozRTCIceCandidate"]||window["msRTCIceCandidate"],d=window["RTCDataChannel"]||window["webkitRTCDataChannel"]||window["mozRTCDataChannel"]||window["msRTCDataChannel"],e=[{"urls":"stun:stun.l.google.com:19302"}];let f=!1;const g=[],h=class extends DOMHandler{constructor(a){super(a,"multiplayer"),this._iceServers=[],this._sigWs=null,this._isSignallingConnected=!1,this._isSignallingLoggedIn=!1,this._sigservInfo={protocolrev:0,version:0,name:"",operator:"",motd:""},this._myId="",this._myAlias="",this._game="",this._gameInstance="",this._room="",this._allPeers=[],this._peersById=new Map,this._nextPeerNid=0,this._usedPeerNids=new Set,this._selfPeer=null,this._hostPeer=null,this._clientDelay=80,this._hostUpdateRateSec=30,this._peerUpdateRateSec=30,this._lastUpdateTime=0,this._stats={lastSecondTime:0,outboundPerSec:0,outboundCount:0,outboundBandwidthPerSec:0,outboundBandwidthCount:0,inboundPerSec:0,inboundCount:0,inboundBandwidthPerSec:0,inboundBandwidthCount:0},this._dataBuffer=new ArrayBuffer(262144),this._dataView=new DataView(this._dataBuffer),this._allRegisteredObjects=[],this._nextObjectNid=1,this._registeredObjectsByNid=new Map,this._registeredObjectsByRoId=new Map,this._simLatency=0,this._simPdv=0,this._simPacketLoss=0,this._lastTimeDiffs=[],this._targetHostTimeDiff=0,this._hostTimeDiff=0,this._targetSimDelay=this._clientDelay,this._simDelay=this._clientDelay,this._allClientValues=[],this._clientValuesByTag=new Map,this._receivedClientValues=!1,this._MergeICEServerList(e),setInterval(()=>this._DoPings(),2e3),window.addEventListener("unload",()=>this.RemoveAllPeers("quit")),this.AddRuntimeMessageHandler("get-supported",()=>this._OnGetSupported()),this.AddRuntimeMessageHandler("add-ice-servers",(a)=>this._MergeICEServerList(a["list"])),this.AddRuntimeMessageHandler("simulate-latency",(a)=>this.SetLatencySimulation(a["latency"],a["pdv"],a["loss"])),this.AddRuntimeMessageHandler("set-bandwidth-profile",(a)=>this.SetBandwidthSettings(a["updateRate"],a["delay"])),this.AddRuntimeMessageHandler("tick",(a)=>this.Tick(a)),this.AddRuntimeMessageHandler("alert",(a)=>this.Alert(a)),this.AddRuntimeMessageHandler("signalling-connect",(a)=>this.SignallingConnect(a["url"])),this.AddRuntimeMessageHandler("signalling-disconnect",()=>this.SignallingDisconnect()),this.AddRuntimeMessageHandler("signalling-login",(a)=>this.SignallingLogin(a["alias"])),this.AddRuntimeMessageHandler("signalling-join-room",(a)=>this.SignallingJoinGameRoom(a["game"],a["instance"],a["room"],a["maxClients"])),this.AddRuntimeMessageHandler("signalling-auto-join-room",(a)=>this.SignallingAutoJoinGameRoom(a["game"],a["instance"],a["room"],a["maxClients"],a["lock"])),this.AddRuntimeMessageHandler("signalling-leave-room",()=>this.SignallingLeaveRoom()),this.AddRuntimeMessageHandler("signalling-list-game-instances",(a)=>this.SignallingRequestGameInstanceList(a["game"])),this.AddRuntimeMessageHandler("signalling-list-rooms",(a)=>this.SignallingRequestRoomList(a["game"],a["instance"],a["which"])),this.AddRuntimeMessageHandler("disconnect-room",()=>this.DisconnectRoom(!0)),this.AddRuntimeMessageHandler("peer-send-message",(a)=>this.OnPeerSendMessage(a)),this.AddRuntimeMessageHandler("host-broadcast",(a)=>this.OnHostBroadcast(a)),this.AddRuntimeMessageHandler("kick-peer",(a)=>this.OnKickPeer(a)),this.AddRuntimeMessageHandler("sync-object",(a)=>this.OnSyncObject(a)),this.AddRuntimeMessageHandler("sync-inst-var",(a)=>this.OnSyncInstVar(a)),this.AddRuntimeMessageHandler("associate-object",(a)=>this.OnAssociateObject(a)),this.AddRuntimeMessageHandler("remove-object-id",(a)=>this.RemoveObjectId(a["uid"])),this.AddRuntimeMessageHandler("remove-net-insts",(a)=>this.OnRemoveNetInsts(a)),this.AddRuntimeMessageHandler("remove-object-nid",(a)=>this.OnRemoveObjectNid(a)),this.AddRuntimeMessageHandler("set-client-state",(a)=>this.SetClientState(a["tag"],a["value"])),this.AddRuntimeMessageHandler("add-client-input-value",(a)=>this.AddClientInputValue(a["tag"],a["precision"],a["interp"]))}_GetErrorMessage(a){return a?"string"==typeof a?a:"string"==typeof a["message"]?a["message"]:"string"==typeof a["details"]?a["details"]:"string"==typeof a["data"]?a["data"]:"string"==typeof a["type"]?a["type"]:"unknown error":"unknown error"}IsConnected(){return this._isSignallingConnected}IsLoggedIn(){return this.IsConnected()&&this._isSignallingLoggedIn}IsInRoom(){return this.IsLoggedIn()&&this._room}IsHost(){return this.IsInRoom()&&this._selfPeer&&this._hostPeer===this._selfPeer}GetMyId(){return this.IsLoggedIn()?this._myId:""}GetMyAlias(){return this.IsLoggedIn()?this._myAlias:""}GetCurrentGame(){return this.IsLoggedIn()?this._game:""}GetCurrentGameInstance(){return this.IsLoggedIn()?this._gameInstance:""}GetCurrentRoom(){return this.IsInRoom()?this._room:""}GetHostId(){return this._hostPeer?this._hostPeer.GetId():""}GetHostAlias(){return this._hostPeer?this._hostPeer.GetAlias():""}GetHostPeer(){return this._hostPeer}GetSelfPeer(){return this._selfPeer}SetLatencySimulation(a,b,c){var d=Math.max;this._simLatency=d(a,0),this._simPdv=d(b,0),this._simPacketLoss=d(c,0)}GetSimulatedPacketLoss(){return this._simPacketLoss}GetSimulatedLatency(){return this._simLatency}GetSimulatedPdv(){return this._simPdv}_OnGetSupported(){return{"isSupported":!!(a&&d)}}SignallingConnect(a){if(!(this._sigWs||this._isSignallingConnected)){try{this._sigWs=new WebSocket(a,"c2multiplayer")}catch(a){return this._sigWs=null,void this._OnSignallingError(a)}this._sigWs.onopen=()=>-1===this._sigWs.protocol.indexOf("c2multiplayer")?(this._OnSignallingError("server does not support 'c2multiplayer' protocol"),this._sigWs.close(1002,"'c2multiplayer' protocol required"),this._sigWs=null,void(this._isSignallingConnected=!1)):void(this._isSignallingConnected=!0),this._sigWs.onclose=()=>{this._OnSignallingClose(),this._isSignallingConnected=!1,this._isSignallingLoggedIn=!1,this._sigWs=null},this._sigWs.onerror=(a)=>{console.error("Signalling server error: ",a),this._OnSignallingError(a)},this._sigWs.onmessage=(a)=>{this._OnSignallingMessage(a)}}}SignallingDisconnect(){this._sigWs&&this._isSignallingConnected&&(this._sigWs.close(),this._sigWs=null,this._isSignallingConnected=!1)}_OnSignallingMessage(a){let b;try{b=JSON.parse(a.data)}catch(a){return void this._OnSignallingError(a)}switch(b["message"]){case"welcome":this._OnSignallingReceiveWelcome(b);break;case"login-ok":this._OnSignallingReceiveLoginOK(b);break;case"join-ok":this._OnSignallingReceiveJoinOK(b);break;case"leave-ok":this._OnSignallingReceiveLeaveOK(b);break;case"kicked":this._OnSignallingReceiveKicked(b);break;case"peer-joined":this._OnSignallingReceivePeerJoined(b);break;case"peer-quit":this._OnSignallingReceivePeerQuit(b);break;case"icecandidate":this._OnSignallingReceiveIceCandidate(b);break;case"offer":this._OnSignallingReceiveOffer(b);break;case"answer":this._OnSignallingReceiveAnswer(b);break;case"instance-list":this._OnSignallingReceiveInstanceList(b);break;case"room-list":this._OnSignallingReceiveRoomList(b);break;case"error":this._OnSignallingError(b["details"]);break;default:this._OnSignallingError("received unknown signalling message");}}HasICEServerUrl(a){for(const b of this._iceServers)if(b["urls"]===a["urls"])return!0;return!1}_MergeICEServerList(a){if(a)for(let b of a)"string"==typeof b&&(b={"urls":b}),this.HasICEServerUrl(b)||(!b.hasOwnProperty("url")&&(b["url"]=b["urls"]),this._iceServers.push(b))}GetICEServerList(){return this._iceServers}_OnSignallingError(a){this.PostToRuntime("signalling-error",{"message":this._GetErrorMessage(a)})}_OnSignallingClose(){this.PostToRuntime("signalling-close")}_OnSignallingReceiveWelcome(a){if(1>a["protocolrev"]||1<a["protocolrev"])return this._OnSignallingError("signalling server protocol revision not supported"),void this.SignallingDisconnect();this._myId=a["clientid"];const b=this._sigservInfo;b.protocolrev=a["protocolrev"],b.version=a["version"],b.name=a["name"],b.operator=a["operator"],b.motd=a["motd"],this._MergeICEServerList(a["ice_servers"]),this.PostToRuntime("signalling-welcome",{"myid":this._myId,"sigservinfo":{"protocolrev":b.protocolrev,"version":b.version,"name":b.name,"operator":b.operator,"motd":b.motd}})}_OnSignallingReceiveLoginOK(a){this._myAlias=a["alias"],this._isSignallingLoggedIn=!0,this.PostToRuntime("signalling-login-ok",{"myalias":this._myAlias})}GetNextObjectNid(){return this._nextObjectNid++}AllocatePeerNid(){if(this.IsHost()){do this._nextPeerNid++,65535<this._nextPeerNid&&(this._nextPeerNid=0);while(this._usedPeerNids.has(this._nextPeerNid));const a=this._nextPeerNid;return this._usedPeerNids.add(a),a}}FreePeerNid(a){this.IsHost()&&this._usedPeerNids.delete(a)}_OnSignallingReceiveJoinOK(a){this.RemoveAllPeers("disconnect"),this._game=a["game"],this._gameInstance=a["instance"],this._room=a["room"],this._selfPeer=new C3Peer(this,this._myId,this._myAlias),a["host"]?(this._hostPeer=this._selfPeer,this._nextPeerNid=0,this._usedPeerNids.clear(),this._hostPeer._SetNid(this.AllocatePeerNid())):(this._lastTimeDiffs.length=0,this._targetHostTimeDiff=0,this._hostTimeDiff=0,this._clientDelay=80,this._hostUpdateRateSec=30,this._peerUpdateRateSec=30,this._targetSimDelay=this._clientDelay,this._simDelay=this._clientDelay,this._hostPeer=new C3Peer(this,a["hostid"],a["hostalias"]),this._hostPeer.Connect()),this.PostToRuntime("signalling-join-ok",{"isHost":!!a["host"],"hostId":this._hostPeer.GetId(),"hostAlias":this._hostPeer.GetAlias(),"game":this._game,"gameInstance":this._gameInstance,"room":this._room})}_OnSignallingReceiveLeaveOK(){this._room="",this.PostToRuntime("signalling-leave-ok")}_OnSignallingReceiveKicked(){this.DisconnectRoom(),this._room="",this.PostToRuntime("signalling-kicked")}_OnSignallingReceivePeerJoined(a){if(this._isSignallingLoggedIn&&this._room&&this.IsHost()){const b=this._peersById.get(a["peerid"]);b&&b.Remove("rejoin");const c=new C3Peer(this,a["peerid"],a["peeralias"]);c.Connect()}}_OnSignallingReceivePeerQuit(a){if(this._isSignallingLoggedIn&&this._room&&this.IsHost()){const b=this._peersById.get(a["id"]);b&&b.Remove(a["reason"])}}_OnSignallingReceiveIceCandidate(a){if(this._isSignallingLoggedIn&&this._room){const b=this._peersById.get(a["from"]);b&&b._AddICECandidate(new c(a["icecandidate"]))}}_OnSignallingReceiveOffer(a){if(!this._isSignallingLoggedIn||!this._room||this.IsHost()||!this._selfPeer||!this._hostPeer||!this._hostPeer.HasPeerConnection())return;if(a["from"]!==this._hostPeer.GetId())return;const c=this._hostPeer.GetPeerConnection();c.setRemoteDescription(new b(a["offer"])).then(()=>{c.createAnswer().then((a)=>{c.setLocalDescription(a),this.SignallingSend({"message":"answer","toclientid":this._hostPeer.GetId(),"answer":a})}).catch((a)=>{console.error("Peer error creating answer: ",a),this._OnPeerError(this._selfPeer,"could not create answer to host offer")})}).catch((a)=>{console.error("Peer error setting remote description: ",a),this._OnPeerError(this._selfPeer,"could not set remote description")})}_OnSignallingReceiveAnswer(a){if(this._isSignallingLoggedIn&&this._room&&this.IsHost()){const c=this._peersById.get(a["from"]);c&&c.GetPeerConnection().setRemoteDescription(new b(a["answer"])).catch((a)=>{console.error("Host error setting remote description: ",a)})}}_OnSignallingReceiveInstanceList(a){this.PostToRuntime("signalling-instance-list",{"list":a["list"]})}_OnSignallingReceiveRoomList(a){this.PostToRuntime("signalling-room-list",{"list":a["list"]})}SignallingSend(a){this._sigWs&&this._isSignallingConnected&&this._sigWs.send(JSON.stringify(a))}SignallingLogin(a){this._isSignallingLoggedIn||this.SignallingSend({"message":"login","protocolrev":1,"alias":a})}SignallingJoinGameRoom(a,b,c,d){!this._isSignallingLoggedIn||this._room||this.SignallingSend({"message":"join","game":a,"instance":b,"room":c,"max_clients":d})}SignallingAutoJoinGameRoom(a,b,c,d,e){!this._isSignallingLoggedIn||this._room||this.SignallingSend({"message":"auto-join","game":a,"instance":b,"room":c,"max_clients":d,"lock_when_full":e})}SignallingLeaveRoom(){this._isSignallingLoggedIn&&this.SignallingSend({"message":"leave"})}SignallingConfirmPeer(a){this._isSignallingLoggedIn&&this.IsHost()&&this.SignallingSend({"message":"confirm-peer","id":a})}SignallingRequestGameInstanceList(a){this._sigWs&&this._isSignallingConnected&&this.SignallingSend({"message":"list-instances","game":a})}SignallingRequestRoomList(a,b,c){this._sigWs&&this._isSignallingConnected&&this.SignallingSend({"message":"list-rooms","game":a,"instance":b,"which":c})}DisconnectRoom(a){this._lastTimeDiffs.length=0,this._targetHostTimeDiff=0,this._hostTimeDiff=0,this.RemoveAllPeers("disconnect"),a&&this.SignallingLeaveRoom()}_AddPeer(a){this._allPeers.push(a),this._peersById.set(a.GetId(),a),this.PostToRuntime("add-peer",{"id":a.GetId(),"alias":a.GetAlias()})}_RemovePeer(a){this.PostToRuntime("remove-peer",{"id":a.GetId()}),this.IsHost()&&this.FreePeerNid(a.GetNid());const b=this._allPeers.indexOf(a);-1<b&&this._allPeers.splice(b,1),this._peersById.delete(a.GetId()),this._hostPeer===a&&(this._hostPeer=null,this.RemoveAllPeers("host quit")),this._selfPeer===a&&(this._selfPeer=null,this._room="",this.RemoveAllPeers("disconnect"))}RemoveAllPeers(a){if(!f){for(f=!0;this._allPeers.length;)this._allPeers[0].Remove(a);f=!1}}GetPeerById(a){return this._peersById.get(a)||null}GetAliasFromId(a){const b=this._peersById.get(a);return b?b.GetAlias():""}GetPeerByNid(a){for(const b of this._allPeers)if(b.GetNid()===a)return b;return null}OnHostBroadcast(a){const b=a["fromId"],c=a["tag"],d=a["message"],e=a["mode"],f=this.GetPeerById(b);this.HostBroadcast(e,JSON.stringify({"c":"m","t":c,"f":b,"m":d}),f)}HostBroadcast(a,b,c){if(this.IsHost()){const d=this._allPeers.slice(0);for(const e of d)e&&e!==this._selfPeer&&e!==c&&e.Send(a,b)}}_DoPings(){const a=performance.now();if(this.IsHost()){g.push(...this._allPeers);for(const b of g)b&&b!==this._selfPeer&&b.SendPing(a,!1);g.length=0}else this._hostPeer&&this._hostPeer.SendPing(a,!1)}AddRegisteredObject(a){this._allRegisteredObjects.push(a),this._registeredObjectsByRoId.set(a.GetRoId(),a),this._registeredObjectsByNid.set(a.GetNid(),a)}GetRegisteredObjectsMap(){const a={};for(const[b,c]of this._registeredObjectsByNid.entries())a[c.GetSid()]={"nid":b,"nvs":c.GetNetValuesJson()};return a}MapObjectNids(a){this._registeredObjectsByNid.clear();for(const b of this._allRegisteredObjects)if(a.hasOwnProperty(b.GetSid().toString())){const c=a[b.GetSid().toString()];b._SetNid(c["nid"]),this._registeredObjectsByNid.set(c["nid"],b),b.SetNetValuesFrom(c["nvs"])}else console.warn("Could not map object SID '"+b.GetSid()+"' - host did not send NID for it"),b._SetNid(-1)}GetRegisteredObjectByNid(a){return this._registeredObjectsByNid.get(a)||null}Tick(a){if(!this.IsInRoom())return null;const b=a["dt"],c=performance.now(),d=this.IsHost()?this._hostUpdateRateSec:this._peerUpdateRateSec;c-this._lastUpdateTime>=1e3/d-5&&(this.SendUpdate(c),this._lastUpdateTime=c);const e=this._stats;1e3<=c-e.lastSecondTime&&(e.outboundPerSec=e.outboundCount,e.outboundBandwidthPerSec=e.outboundBandwidthCount,e.inboundPerSec=e.inboundCount,e.inboundBandwidthPerSec=e.inboundBandwidthCount,e.outboundCount=0,e.outboundBandwidthCount=0,e.inboundCount=0,e.inboundBandwidthCount=0,e.lastSecondTime+=1e3,500<c-e.lastSecondTime&&(e.lastSecondTime=c),this.PostToRuntime("stats",{"stats":{"outboundPerSec":e.outboundPerSec,"outboundBandwidthPerSec":e.outboundBandwidthPerSec,"inboundPerSec":e.inboundPerSec,"inboundBandwidthPerSec":e.inboundBandwidthPerSec}})),this.IsHost()||(this._hostTimeDiff<this._targetHostTimeDiff?(this._hostTimeDiff+=10*b,this._hostTimeDiff>this._targetHostTimeDiff&&(this._hostTimeDiff=this._targetHostTimeDiff)):this._hostTimeDiff>this._targetHostTimeDiff&&(this._hostTimeDiff-=10*b,this._hostTimeDiff<this._targetHostTimeDiff&&(this._hostTimeDiff=this._targetHostTimeDiff)),this._simDelay<this._targetSimDelay?(this._simDelay+=30*b,this._simDelay>this._targetSimDelay&&(this._simDelay=this._targetSimDelay)):this._simDelay>this._targetSimDelay&&(this._simDelay-=30*b,this._simDelay<this._targetSimDelay&&(this._simDelay=this._targetSimDelay)));const f=this.GetSimulationTime();for(const b of this._allPeers)b.Tick(f);for(const b of this._allRegisteredObjects)b.Tick();return{"simulationTime":this.GetSimulationTime(),"hostInputArrivalTime":this.GetHostInputArrivalTime(),"clientDelay":this._clientDelay,"peerData":this._GetPeerRuntimeData(),"roData":this._GetRegisteredObjectRuntimeData(),"isReadyForInput":this.IsReadyForInput()}}_GetPeerRuntimeData(){const a={};for(const b of this._allPeers){const c={};for(const a of this._allClientValues)c[a.GetTag()]=b.GetInterpClientState(a);a[b.GetId()]={"nid":b.GetNid(),"latency":b.GetLatency(),"pdv":b.GetPdv(),"clientState":c}}return a}_GetRegisteredObjectRuntimeData(){const a={};for(const b of this._allRegisteredObjects)a[b.GetRoId()]=b.GetRuntimeData();return a}async SendUpdate(a){this.IsHost()?(await this._SendHostUpdate(a),this._SendHostEvents(a)):await this._SendClientUpdate(a)}async _OnBeforeClientUpdate(){const a=await this.PostToRuntimeAsync("before-client-update");for(const b of a["clientStateUpdates"])this.SetClientState(b["tag"],b["value"])}async _SendClientUpdate(a){if(this.IsReadyForInput()&&(await this._OnBeforeClientUpdate()),!this._selfPeer||!this._receivedClientValues)return;const b=this._dataView;let c=0;const d=this._allClientValues,e=this._selfPeer.GetLocalClientState(),f=a-this._selfPeer.GetLastStateChange(),g=a-this._selfPeer.GetLastStateTransmit();let h=!1;if(h=!!(100>f)||(1e3>f?95<=g:495<=g),!!h){b.setUint32(c,1664249200),c+=4,b.setFloat64(c,a+this._hostTimeDiff),c+=8,b.setUint8(c,0),c+=1,b.setUint8(c,d.length),c+=1;for(let a=0,f=d.length;a<f;++a){const f=d[a];let g=0;a<e.length&&(g=f.Clamp(e[a])),c=f.Write(b,c,g)}this._selfPeer._SetLastStateTransmit(a),this._hostPeer.Send("u",new Uint8Array(this._dataBuffer,0,c))}}async _SendHostUpdate(a){const b=this._dataView;let c=0,d=0;const e=await this.PostToRuntimeAsync("get-object-info",{"ros":this._allRegisteredObjects.map((a)=>a.GetRuntimeInfoRequest())});for(const b of this._allRegisteredObjects){const c=b.GetRoId();if(!e.hasOwnProperty(c))continue;const f=e[c];b.UpdateData(f,a),0<b.GetNumberToTransmit()&&d++}if(0!=d){b.setUint32(c,1664249200),c+=4,b.setUint32(c,0),c+=4,b.setFloat64(c,a),c+=8,b.setUint16(c,d),c+=2;for(const d of this._allRegisteredObjects)0<d.GetNumberToTransmit()&&(c=d.WriteData(b,c,a));this.HostBroadcast("u",new Uint8Array(this._dataBuffer,0,c),null)}}_SendHostEvents(a){const b=this._dataView;let c=0,d=0;for(const b of this._allRegisteredObjects)b.GetDeadNids().length&&d++;if(0!=d){b.setUint32(c,1664249200),c+=4,b.setUint32(c,1),c+=4,b.setFloat64(c,a),c+=8,b.setUint16(c,d),c+=2;for(const a of this._allRegisteredObjects){const d=a.GetDeadNids();if(d.length){b.setUint16(c,a.GetNid()),c+=2,b.setUint16(c,d.length),c+=2;for(const a of d)b.setUint16(c,a),c+=2;d.length=0}}this.HostBroadcast("r",new Uint8Array(this._dataBuffer,0,c),null)}}AddHostTime(a,b,c,d){if(this.IsHost())return;this._targetSimDelay=d+this._clientDelay;var e=a+c-b;0===this._lastTimeDiffs.length&&(this._hostTimeDiff=e,this._simDelay=this._targetSimDelay),this._lastTimeDiffs.push(e),30<this._lastTimeDiffs.length&&this._lastTimeDiffs.shift(),g.push(...this._lastTimeDiffs),g.sort((c,a)=>c-a);let f=0,h=g.length;4<=g.length&&6>=g.length?(++f,--h):6<g.length&&19>=g.length?(f+=2,h-=2):19<g.length&&(f+=5,h-=5);let j=0;for(let e=f;e<h;++e)j+=g[e];this._targetHostTimeDiff=j/(h-f),g.length=0}GetSimulationTime(){return this.IsHost()?performance.now()-this._clientDelay:performance.now()+this._hostTimeDiff-this._simDelay}GetHostTime(){return this.IsHost()?performance.now():performance.now()+this._hostTimeDiff}GetHostInputArrivalTime(){return this.IsHost()?performance.now():performance.now()+this._hostTimeDiff+this._simDelay}SetClientState(a,b){if(!this.IsHost()&&this._selfPeer&&this._receivedClientValues){const c=this._clientValuesByTag.get(a);if(c){const a=c.GetIndex(),d=this._selfPeer.GetLocalClientState();d.length<a+1&&(d.length=a+1),d[a]!==b&&(d[a]=b,this._selfPeer._SetLastStateChange(performance.now()))}}}AddClientInputValue(a,b,c){const d=new C3NetValue(this._allClientValues.length,c,b,a,null);this._clientValuesByTag.set(a,d),this._allClientValues.push(d)}GetClientValues(){return this._allClientValues}GetClientValuesJson(){const a=[];for(const b of this._allClientValues)a.push({"tag":b.GetTag(),"precision":b.GetPrecision(),"interp":b.GetInterp()});return a}MapClientValues(a){this._clientValuesByTag.clear(),this._allClientValues.length=0;for(let b=0,c=a.length;b<c;++b){const c=a[b],d=new C3NetValue(b,c["interp"],c["precision"],c["tag"],null);this._clientValuesByTag.set(d.GetTag(),d),this._allClientValues.push(d)}this._receivedClientValues=!0}RemoveObjectId(a){for(const b of this._allRegisteredObjects)b.RemoveObjectId(a)}peers(){return this._allPeers}GetPeerCount(){return this.IsInRoom()?this._allPeers.length:0}GetPeerAt(a){return a=Math.floor(a),!this.IsInRoom()||0>a||a>=this._allPeers.length?null:this._allPeers[a]}IsReadyForInput(){return!!this.IsInRoom()&&(!!this.IsHost()||0!==this._targetHostTimeDiff)}SetBandwidthSettings(a,b){this.IsInRoom()||(this._hostUpdateRateSec=a,this._peerUpdateRateSec=a,this._clientDelay=b)}_OnPeerOpen(a){this.PostToRuntime("peer-open",{"id":a.GetId(),"alias":a.GetAlias()})}OnPeerSendMessage(a){const b=a["id"],c=a["tag"],d=a["message"],e=a["mode"],f=this.GetPeerById(b);f&&f.Send(e,JSON.stringify({"c":"m","t":c,"m":d}))}_OnPeerClose(a,b){this.PostToRuntime("peer-close",{"id":a.GetId(),"alias":a.GetAlias(),"reason":b||"unknown"})}_OnPeerError(a,b){console.error(`[Multiplayer] Peer '${a.GetAlias()}' (${a.GetId()}) error: `,b)}_OnPeerMessage(a,b){const c=b["f"]||a.GetId();this.PostToRuntime("peer-message",{"tag":b["t"],"fromId":c,"fromAlias":this.GetAliasFromId(c),"content":b["m"]})}_OnInstanceDestroyed(a,b,c){this.PostToRuntime("instance-destroyed",{"roId":a.GetRoId(),"nid":b,"timestamp":c})}OnKickPeer(a){if(this.IsHost()){const b=a["id"],c=a["reason"],d=this.GetPeerById(b);d&&d.Remove(c,!0)}}StatIncOutboundCount(){this._stats.outboundCount++}StatAddOutboundBandwidthCount(a){this._stats.outboundBandwidthCount+=a}StatIncInboundCount(){this._stats.inboundCount++}StatAddInboundBandwidthCount(a){this._stats.inboundBandwidthCount+=a}SetClientDelay(a){this._clientDelay=a}GetClientDelay(){return this._clientDelay}SetPeerUpdateRateSec(a){this._peerUpdateRateSec=a}GetPeerUpdateRateSec(){return this._peerUpdateRateSec}OnSyncObject(a){const b=a["data"],c=a["precision"],d=a["bandwidth"];for(const e of a["objectClasses"]){const a=new C3RegisteredObject(this,e["roId"],e["sid"],d);1===b?(a.AddValue(1,c,"x"),a.AddValue(1,c,"y")):2===b?a.AddValue(2,c,"a"):3===b&&(a.AddValue(1,c,"x"),a.AddValue(1,c,"y"),a.AddValue(2,c,"a"))}}Alert(a){alert(a["message"])}OnSyncInstVar(a){const b=a["precision"],c=a["interp"],d=a["cvt"];for(const e of a["syncData"]){const a=this._registeredObjectsByRoId.get(e["roId"]);a.AddValue(c,b,"iv",e["varIndex"],d)}}OnAssociateObject(a){const b=a["roId"],c=a["peerId"],d=a["instUid"],e=this._registeredObjectsByRoId.get(b),f=this._peersById.get(c);e&&f&&(!this.IsHost()||e.OverrideNid(d,f.GetNid()))}OnRemoveNetInsts(a){for(const[b,c]of Object.entries(a)){const a=this._registeredObjectsByRoId.get(parseInt(b,10));if(a)for(const b of c)a.RemoveObjectNid(b)}}OnRemoveObjectNid(a){const b=a["roId"],c=a["nid"],d=this._registeredObjectsByRoId.get(b);d&&d.RemoveObjectNid(c)}};RuntimeInterface.AddDOMHandlerClass(h)}"use strict";{const a=class extends DOMHandler{constructor(a){super(a,"mouse"),this.AddRuntimeMessageHandler("cursor",(a)=>this._OnChangeCursorStyle(a))}_OnChangeCursorStyle(a){document.body.style.cursor=a}};RuntimeInterface.AddDOMHandlerClass(a)}"use strict";{const a=class extends DOMHandler{constructor(a){super(a,"touch"),this.AddRuntimeMessageHandler("request-permission",(a)=>this._OnRequestPermission(a))}async _OnRequestPermission(a){const b=a["type"];let c=!0;0===b?c=await this._RequestOrientationPermission():1===b&&(c=await this._RequestMotionPermission()),this.PostToRuntime("permission-result",{"type":b,"result":c})}async _RequestOrientationPermission(){if(!self["DeviceOrientationEvent"]||!self["DeviceOrientationEvent"]["requestPermission"])return!0;try{const a=await self["DeviceOrientationEvent"]["requestPermission"]();return"granted"===a}catch(a){return console.warn("[Touch] Failed to request orientation permission: ",a),!1}}async _RequestMotionPermission(){if(!self["DeviceMotionEvent"]||!self["DeviceMotionEvent"]["requestPermission"])return!0;try{const a=await self["DeviceMotionEvent"]["requestPermission"]();return"granted"===a}catch(a){return console.warn("[Touch] Failed to request motion permission: ",a),!1}}};RuntimeInterface.AddDOMHandlerClass(a)}